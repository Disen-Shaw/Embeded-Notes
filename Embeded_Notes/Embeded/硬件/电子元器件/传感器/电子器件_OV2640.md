# OV2640
## 简介
OV2640是 `OmniVision` 公司生产的一个 $\frac14$ 寸的 `CMOS UXGA(1632*1232)` 图像传感器  
该传感器体积小、工作电压低，提供单片 `UXGA` 摄像头和影像处理所需要的所有功能  
+ **通过SCCB总线控制**
+ 可以输出整帧、子采样、缩放和取窗口等方式的各种分辨率$\frac8{10}$位影像数据
+ `UXGA(1632*1232)`最高15帧/秒、`SVGA(800*600)`可达30帧/秒、`CIF(352*288)`可达60帧/秒

用户可以完全控制图像质量、数据格式和传输方式  
**图像处理功能包括**  
+ 伽马曲线
+ 白平衡
+ 对比度
+ 色度等  
通过SCCB接口编程

## 特点
+ 高灵敏度，低电压适合嵌入式应用
+ 标准的SCCB接口，兼容IIC接口
+ 支持`RawRGB`、`RGB(RGB565/RGB555)`、`GRB422`、`YUV(422/420)` 和 `YCbCr(422)` 输出格式
+ 支持`UXGA`、`SXGA`、`SVGA` 以及 **按比例缩小** 到从 `SXGA` 到 `40×30` 的各个尺寸
+ 支持自动曝光、自动增益控制、自动白平衡、自动消除灯光条纹、自动黑电平校准等自动控制功能
+ 支持饱和度、色相、伽马、锐度等设置
+ 支持图像缩放和闪光灯
+ **支持图像压缩，即可以输出JPEG格式图像数据**

## 基本概念
### 分辨率
+ UXGA：分辨率为1600x1200的输出格式
+ SXGA(1280x1024)
+ XVGA(1280x720)
+ WXGA(1280x800)
+ XGA(1024x768)
+ SVGA(800x600)
+ VGA(640x480)
+ CIF(352x288)
+ QQVGA(160x120)等

### 其他
+ PCLK：像素时钟，一个PCLK时钟输出一个或者半个像素
+ VSYNC：帧同步信号
+ HREF/HSYNC：行同步信号

> OV2640d的图像数据输出（通过Y[9:0]，不过一般之用8位数据）就是在PCLK、VSYNC和HREF/HSYNC的控制下进行

## 时序信息
### 行输出时序
![Pasted image 20210918181357](../../../../pictures/Pasted%20image%2020210918181357.png)

PCLK时钟最大可达36MHz  

图像数据在HREF为高电平的时候输出，当HREF便高之后，**每一个PCLK时钟输出一个字节数据**  
例如采用 `UXGA` 时序，RGB565格式输出，每两个字节组成一个像素的颜色(低字节在前，高字节在后)，这样每行输出总共有(1600x2)个PCLK周期，输出1600x2个字节

### 帧输出时序
![Pasted image 20210918180713](../../../../pictures/Pasted%20image%2020210918180713.png)

+ OV2640支持RGB565或者JPEG输出，RGB565输出时，时序如上  
+ JPEG输出时，PCLK大大减少，
	+ 而且HREF不连续
	+ 数据流以0xFF、0xD8开头
	+ 以0xFF、0xD9结束
	+ 将这期间的数据保存为.jpg格式就可以在图像查看器上打开查看

## 传感器窗口设置
传感器窗口设置允许用户设置整个传感器区域(1632x1220)的感兴趣的部分  
也就是在传感器里面开窗，开窗范围 (2x2～1632x1220) 都可以设置，不过要求这个窗口必须大于等于随后设置的图像尺寸  

传感器窗口设置通过：0x30、0x19、0x1A、0x07、0x17、0x18等寄存器设置 [datasheet](https://www.alldatasheetcn.com/view.jsp?Searchword=OV2640)

## 图像尺寸设置
图像尺寸设置，也就是 `DSP` 输出(最终输出到LCD的)图像的最大尺寸  
该尺寸要小于等于之前的窗口尺寸  

图像尺寸通过：0xC0、0xC1、0x8C等寄存器设置

## 图像窗口设置
类似于最初的窗口设置，这个窗口实在前面设置的图像尺寸里面，再一次设置窗口大小，这个窗口大小必须小于等于前面设置的图像尺寸  
该窗口设置后的图像范围将用于输出到外部  

图像窗口设置通过：0x51、0x52、0x53、0x53、0x55、0x57等寄存器设置

## 图像输出大小设置
控制最终输出到外部的图像尺寸  
该设置将图像窗口设置所决定的窗口大小，通过内部的DSP处理，缩放成输出到外部的图像大小  
该设置会将图像进行缩放处理，如果设置的图像输出大小不等于图像窗口设置图像大小，那么图像就会被缩放处理  
只有两者设置一样大时，输出比例才是1：1的 

图像输出大小设置通过：0x5A、0x5B、0x5C等寄存器设置


## 图像输出窗口示意
![Pasted image 20210918184420](../../../../pictures/Pasted%20image%2020210918184420.png)


## ov2640模块
![Pasted image 20210918184831](../../../../pictures/Pasted%20image%2020210918184831.png)
### 特点
+ 支持RGB565/JPEG数据输出
+ 支持最大UXGA分辨率输出
+ 支持图像任意缩放
+ 自带24M有源晶振，无需外部时钟
+ 自带稳压电路，接3.3V即可工作
+ 自带感红外镜头(有滤光片)，色彩鲜艳、可手动对焦
+ 体积小巧



### 对外接口
| 序号      | 名称     | 说明                       |
| --------- | -------- | -------------------------- |
| 1         | GND      | 地线                       |
| 2         | VCC3.3V  | 3.3V电源输入线             |
| 3         | ov_SCL   | SCCB时钟线($IN^1$)         |
| 4         | ov_VSYNC | 帧同步信号                 |
| 5         | ov_SDA   | SCCB数据线(IN/OUT)         |
| 6         | ov_HREF  | 行参考信号(OUT)            |
| 7.9~14.16 | ov_D0~D7 | 数据线(OUT)                |
| 8         | ov_RESET | 复位信号(地点评有效)IN     |
| 15        | ov_PCLK  | 像素时钟(OUT)              |
| 17        | ov_PWDN  | 掉电模式使能(高电平有效)IN |
| 18        | NC       | 未使用                     |

## 初始化过程
+ 初始化MCU的IO口
+ 上电复位
+ 读取传感器ID
+ **执行初始化序列**
+ 完成初始化


## MCU读取模块图像数据过程
+ 等待帧同步信号
+ 等待HREF为高电平
+ 等待第一个PCLK上升沿
+ 读取第一个像素低字节
+ 读取第二个PCLK上升沿
+ 读取第一个**像素**高字节
+ 等待第三个PCLK上升沿
+ ... ... 
+ 循环读取剩余像素
+ 结束

