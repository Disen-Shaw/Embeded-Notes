# SDRAM
笔记型号为`W9825G6KH`(32MByte)
## 内部功能框架
![[Pasted image 20210613230001.png]]

### SDRAM信号线
|      信号线       | 类型 | 说明                                                  |
|:-----------------:| ---- | ----------------------------------------------------- |
|        CLK        | I    | 同步时钟信号，所有输入信号都在CLK为上升沿的时候被采集 |
|        CKE        | I    | 时钟使能信号，禁止时钟信号时SDRAM会自动刷新操作       |
|        CS#        | I    | 片选信号，低电平有效                                  |
|       CAS#        | I    | 列地址选通，为低电平时地址线表示的是列地址            |
|       RAS#        | I    | 行地址选通，为低电平时地址线表示的是行地址            |
|        WE#        | I    | 写入使能，低电平有效                                  |
|    DQM\[0：1]     | I    | 数据输入/输出掩码信号，表示DQ信号线的有效部分         |
| **BS(BA)\[0：1]** | I    | **Bank地址输入，选择要控制的Bank**                        |
|     A\[0:12]      | I    | 地址输入                                              |
|     DQ\[0:15]     | I/O  | 数据输入输出信号                                      |


### 控制逻辑
SRAM内部的"控制逻辑"指挥着整个系统的运行，外部可以通过CS、WE、CAS、RAS以及地址线来向控制逻辑输入命令，命令经过"命令译码器"译码，并将控制参数保存在"模式寄存器中"，控制逻根据此来运行

### SDRAM的存储阵列
![[Pasted image 20210612222400.png]]
SRAN内部包含的存储阵列，可以把它理解成一个表格，数据就在表格上。和表格查找一直，指定一个行地址和一个列地址，就可以精准找到单元格，这个是SRAM芯片的寻址原理。这样的每个单元格被称为单元，而这样的表则称为存储矩阵。
目前设计的SDRAM芯片基本上内部都包含4个这样的Bank，寻址时指定Bank号以及行地址，然后再指定列地址就可以寻找到目标存储单元

#### 具有多个Bank的结构
![[Pasted image 20210613231828.png]]
通讯时当RAS线为低电平，则"行地址选通器"被选通，地址线A\[11:0]表示的地址会被输入到"行地址译码及锁存器"中，作为存储阵列中选定的行地址，同时地址线BA\[1:0]表示的Bank也被所存，选中了要操作的Bank号，接着控制CAS线为低电平，"列地址选通器"被选通，地址线A\[11:0]表示的地址会被所存到"列地址译码器"中作为列地址，完成寻址过程。

Bank号->行地址->列地址
### 地址控制
SDRAM包含有"A"类以及**BA**两类地址线，A类地址线是行(Row)与列(Column)共用的地址总线，BA地址线是独立的用于指定SDRAM内部存储阵列号(Bank)
在命令模式下，A类地址还用于某些命令输入参数

### 数据的输入输出
SDRAM的数据通过DQ信号线输出，在于SDRAM进行数据通讯时
**16位的数据是同步传输的**
但是机盈盈中我们可能会以8位，16位的宽度存取数据，16为的数据线不是什么时候都可以用的，而且在传输低宽度数据时，不希望其他数据线表示的数据被录入，这时使用DQM信号线作为掩码信号，控制要读取的哪个字节

### 控制SDRAM的命令
#### 命令禁止
只要CS引脚为高电平
表示"命令禁止"，用于禁止SDRAM执行新的命令，但不能停止当前正在进行的指令
#### 空操作
"空操作","命令禁止"的反操作，用于选中SDRAM以便接下来的命令。
#### 行有效
进行存储单元寻址时，需要先选中要访问的Bank和行，使它处于激活状态
该操作通过"行有效(ACTIVE)"命令实现，发送行有命令时，RAS线为低电平，同时通过BA线以及A线发送Bank地址和行地址

#### 列读写
![[Pasted image 20210614021522.png]]
读命令和写命令的时序很相似，通过公用的地址线A发送列地址，同时使用WE引脚表示读写方向，高电平表示读，低电平表示写
数据读写时，使用DQM线表示有效的DQ数据线。

#### 预充电
![[Pasted image 20210614021819.png]]
SDRAM的寻址具有独占性，所以在进行万读写操作后，如果要对同一个Bank的另一行进行寻址，就要将原来有效的行关闭，重新发送行/列地址
Bank关闭当前工作行，准备打开新行的操作就是预充电

配合使用A10线控制
+ A10为高电平时，所有Bank都与充电
+ A10为低电平时，使用BA线选择要充电的Bank

#### 刷新
SDRAM要不断进行刷新才能留住数据，因此它是DRAM最重要的操作。
刷新操作与与充电中重写的操作本质是一样的，但因为预充电是对一个或所有Bank中的在工作行操作，并且不定期，而刷新则是有固定的周期，一次对所有行进行操作，保证那些久久没有被访问的存储单元数据正确

刷新操作分为两种：
+ 自动刷新
+ 自刷新

发送命令后CKE始终为有效电平(低电平)，使用自动刷新操作，否则使用自刷新操作。
不论是什么刷新方式，都不需要外部提供行地址，因为这是一个内部的自动操作

##### 自动刷新
SDRAM内部有一个行地址生成器(刷新计数器)用来自动依次生成行地址，没收到一次命令刷新一行。
在刷新过程中，所有Bank都停止工作，而每次刷新所占用的时间为N个时钟周期(N根据SDRAM型号而定，通常为9)刷新结束后才能进入正常的工作状态。
在这N个时钟周期中，所有工作指令只能等待，无法执行
一次次按行刷新，刷新完成后，再对第一行进行刷新操作。这个对同一行刷新操作的时间间隔，成为SDRAM刷新周期，通常是64ms

**刷新会对SDRAM的性能造成影响，但这时由SDRAM的特性决定的，也是SDRAM相对于SRAM取得成本优势的代价**

##### 自刷新
主要用于休眠模式低功耗状态下的数据保存
此时外部控制器不工作了，SDRAM能够自己保持数据正常。
在发出自刷新命令后，将CKE置于无效状态(低电平)，进入自我刷新模式
此时不再依靠外部时钟工作，而是根据SDRAM内部的时钟进行刷新操作

自刷新期间除了CKE之外的所有外部信号都是无效的，只有重新使CKE有效才能退出自我刷新模式，并且进入正常操作状态。

### 加载模式寄存器
#### Burst Length
同一行中相邻的存储单元连续进行数据传输的方式，连续传输所涉及到存储单元(列)的数量就是突发长度

#### BT
模式寄存器中的BT位用于设置突发模式，突发模式分为
+ 顺序
+ 间隔

在顺序方式中，操作按地址的顺序连续执行
在间隔模式中，操作地址是跳跃的

#### OP Mode
Operating Mode
SDRAM的工作模式
当它被设置为00时，则表示其工作在正常模式
其他值是测试模式或被保留的设定
实际使用时必须设置为正常模式

#### WB
WB用于配置写操作的突发特性，可选择使用BL设置的突发长度或非突发


## SDRAM的初始化流程
并不是上电后立即开始读写数据的，它需要俺步骤进行初始化，对存储矩阵进行预充电、刷新并设置模式寄存器

![[Pasted image 20210614025801.png]]
1. 为SDRAM的NOP命令给上电(提供时钟)，这个由FMC控制器默认控制
2. 上电后，保持QDM和CKE引脚为高电平至少200us
3. 延迟200us之后，需要对所有的Bank进行预充电
4. 预充电完成后，需要发出模式设置命令以变成SDRAM的模式寄存器，设置SDRAM的工作模式
5. 在变成SDRAM模式寄存器之前或之后，需要插入8个自动刷新周期

## SDRAM的读写流程
配置好`FMC`就可以自动控制
### 读时序
![[Pasted image 20210614030443.png]]

### 写时序
![[Pasted image 20210614030611.png]]

### SDRAM读写流程
+ 发送"行有效"命令，发送命令的同时包含行地址和Bank地址，然后等待t_RCD时间，t_RCD表示行有效命令与读/写命令之间的延迟
+ 发送"读/写"命令，在发送命令的同时发送列地址，完成寻址的地址输入。
	+ 对于读命令，根据模式寄存器的CL定义，延迟CL个时钟周期后，SDRAM的数据线DQ才输出有效数据
	+ 而写命令是没有CL延迟的，注记载发送写命令的同时就可以把要写入的数据用DQ输入到SDRAM中，这是读命令与写命令的时序的最主要的区别
	+ 图中的读写命令都是通过地址线A10控制自动预充电，而SDRAM接收到带预充电要求的读写命令后，并不会立即预充电，而是等待t_WR时间才开始，t_WR表示写命令与预充电之间的延迟

+ 执行与重点命令后，需要时间t_RP时间，t_RP表示预充电与其他命令之间的延迟
+ 图中4处的t_RAS表示自刷新周期，即在前一个”行有效“与”预充电“命令之间的时间
+ 发送第二次”行有效”命令准备读写下一个数据，在途中标号5处的t_RC，表示两个行有效命令或两个刷新命令之间的延迟



## 初始化流程
1. 保持MCU引脚电平状态为SDRAM的NOP命令给上电(提供时钟)
	+ 这个一般由FMC控制器默认控制

2. 上电后保持DQM和CKE引脚为高电平至少200us
3. 延迟200us后，需要对所有Banks进行预充电
4. 预充电完成后，需要发出设置命令以变成SDRAM的模式寄存器，设置SDRAM的工作模式
5. 在编程SDRAM模式寄存器之前或者之后，需要插入8个自动刷新周期