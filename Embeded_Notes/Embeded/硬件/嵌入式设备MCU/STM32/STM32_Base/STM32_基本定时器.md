# STM32定时器
## STM32定时器功能
输入捕获：脉冲计数、上升沿或者下降沿时间检测、PWM输入检测
输出比较：脉冲输出、可以用于步进电机的控制
PWM：电压输出控制、直流减速电机控制、直流无刷电机控制
编码器的接口、霍尔传感器接口
## 定时器分类
基本定时器、通用定时器、高级定时器
高级定时器有TIM1和TIM8
通用定时器TIM2/3/4/5
基本定时器TIM6/7
基本定时器所有功能通用定时器都有
高级>通用>基本定时器

## 定时器功能比较
![Pasted image 20210401191320](../../../../../pictures/Pasted%20image%2020210401191320.png)
### 引脚分部
![Pasted image 20210401192440](../../../../../pictures/Pasted%20image%2020210401192440.png)
### 计数模式
向上计数
向下计数
中间计数
## 基本定时器的功能
基本定时功能，当累加脉冲数超过预订值，能出发中断或者触发DMA请求
专门用于驱动数模转换器
**Tim6和Tim7完全独立，可以同时使用**

![Pasted image 20210401193750](../../../../../pictures/Pasted%20image%2020210401193750.png)
自动重装载寄存器、预分频寄存器下有阴影
根据控制位的设定，在定时器更新时间时传送预装在寄存器至实际寄存器
物理上，这个寄存器对应两个寄存器，一个是写入或者读出的寄存器，称为预装载寄存器，另一个是影子寄存器(真正起作用的寄存器)
### 时钟源
基本定时器的时钟源只能来自内部时钟，由CK_INT提供
定时器的时钟不是直接来自APB1或者APB2,二十来子输入为APB1或APB2的一个倍频器

**当TIM6、7的控制寄存器1(TIMx_CR1)的CEN位置为1时，内部时钟向与分频器提供时钟**
### 控制器
对视起控制器，对基本定时器的复位、使能以及计数空间的控制，甚至专门用于DAC转换触发
### 计数器
实现定时的功能涉及到三个寄存器：
+ 计数器寄存器(TIMx_CNT)
+ 预分频寄存器(TIMx_PSC)
+ 自动重装载寄存器(TIMx_ARR)
三个寄存器都是16位有效

预分频器有一个输入时钟CK_PSC和一个输出时钟CK_CNT，输入时钟来源于控制器部分，通过设置预分频的数值，可以得到不同的CK_CNT
计算公式：
$$
CK\_CNT = FCK\_PSC/(PSC[15::0]+1)
$$

因为TIM_PSC控制寄存器具有缓冲(影子寄存器),可以在运行过程中改变它的数值，新的预分频值将在下一个更新事件时起作用

基本定时器只能向上计数，在计时器使能后(CEN置1)，计数器COUNTER根据CK_CNT频率向上计数，每一个CK_CNT脉冲，TIM_CNT的值就加1,当TIMx_CNT值与TIMx_ARR的设定相等时，就会自动生成事件(产生DMA请求、产生中断信号或者触发DAC同步电路)，并且TIMx_CNT自动清零，然后可以重新计数

因此只要设定PSC和TIM_ARR两个寄存器的值，就可以控制事件生成时间

### 定时器时间的计算
`以72Mhz主控为例`
 PSC=72-1，定时器频率=72M/(PSC+1)=1MHz
 ARR=1000-1从0计数到999，则记了1000次
 中断周期T=1000\*1/100000 = 1ms

[STM32_定时器编程](../SoftWare/STM32_定时器编程.md)




