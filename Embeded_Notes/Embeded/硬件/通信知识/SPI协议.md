## SPI
SPI 协议是由摩托罗拉公司提出的通讯协议(Serial Peripheral Interface),即串行外围设备接口,是一种高速全双工的通信总线。它被广泛地使用在 ADC、LCD 等设备与 MCU 间,要求通讯速率较高的场合。

### SPI物理层
![[Pasted image 20210310124645.png]]

SPI 通讯使用 3 条总线及片选线,3 条总线分别为 SCK、MOSI、MISO,片选线为SS

### SPI通讯过程
![[Pasted image 20210310124738.png]]

这是一个主机的通讯时序。
NSS、SCK、MOSI 信号都由主机控制产生,而 MISO 的信号由从机产生
主机通过该信号线读取从机的数据。
MOSI 与 MISO 的信号只在 NSS 为低电平的时候才有效,在 SCK 的每个时钟周期 MOSI 和 MISO 传输一位数据。

### 通讯的起始信号和停止信号

NSS片选信号线由高变低,是 SPI 通讯的起始信号
当从机在自己的 NSS 线检测到起始信号后,就知道自己被主机选中了,开始准备与主机通讯

### SPI数据有效性
SPI 使用 MOSI 及 MISO 信号线来传输数据,使用 SCK 信号线进行数据同步
MOSI及 MISO 数据线在 SCK 的每个时钟周期传输一位数据,且数据输入输出是同时进行的
MSB 先行或 LSB 先行并没有作硬性规定,但要保证两个 SPI 通讯设备之间使用同样的协定

### 通讯模式
![[Pasted image 20210310125136.png]]
![[Pasted image 20210310125409.png]]

SPI 一共有四种通讯模式,它们的主要区别是总线空闲时 SCK 的时钟状态以及数据采样时刻

|SPI模式|CPOL|CPHA|空闲时SCK时钟|采样时刻|
|---|---|---|---|---|
|0|0|0|低电平|奇数边沿|
|1|0|0|低电平|偶数边沿|
|2|1|0|高电平|奇数边沿|
|3|1|1|高电平|偶数边沿|

时钟极性 CPOL 是指 SPI 通讯设备处于空闲状态时,SCK 信号线的电平信号(即 SPI 通讯开始前、 NSS 线为高电平时 SCK 的状态)。CPOL=0 时, SCK 在空闲状态时为低电平,CPOL=1 时,则相反。


时钟相位 CPHA 是指数据的采样的时刻
当 CPHA=0 时,MOSI 或 MISO 数据线上的信号将会在 SCK 时钟线的“奇数边沿”被采样。
当 CPHA=1 时,数据线在 SCK 的“偶数边沿”采样。

SPI 的采样时刻不是由上升/下降沿决定的
