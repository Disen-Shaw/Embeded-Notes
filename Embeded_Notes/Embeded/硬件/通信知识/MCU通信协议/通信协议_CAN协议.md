# CAN协议
## 简介
`CAN` 是控制器局域网络(Controller Area Network)的简称，它是由研发和生产汽车电子产品著称的 `德国BOSCH公司` 开发的，并最终成为国际标准，是国际上应用最广泛的现场总线之一  
该总线协议已经成为汽车计算机控制系统和嵌入式工业控制局域网的标准总线，并且拥有以 `CAN` 为底层协议专为大型火车和重工机械车辆设计的 `J1939协议`  

近年来，它具有的高可靠性和良好的错误检测能力受到重视，被广泛应用于汽车计算机控制系统和环境温度恶劣、电磁辐射强及振动大的工业环境

## CAN物理层
与 `I2C`、`SPI` 等具有时钟信号的同步通讯方式不同，`CAN` 通讯并不是以时钟来进行同步的，它是一种异步通讯，只具有 `CAN_High` 和 `CAN_Low` 两条信号线，共同构成一组差分信号线，以 **差分信号** 的形式进行通讯

`CAN` 物理层的形式主要分为
+ 闭环总线：适合于高速通讯
+ 开环总线网络两种：适合于远距离通讯

### 闭环总线网络
一种遵循 `ISO11898` 标准的高速、短距离网络，它的总线最大长度为40m，通信速度最高为1MBps，总线的两端各要求有一个 $120\Omega$ 的电阻

![[Pasted image 20210919014629.png]]


### 开环总线网络
一种遵循 `ISO11519-2` 标准的低速、远距离网络，它的最大传输距离是 1Km ，最高通讯速率为 125kbps ，两根总线是独立的、不形成闭环，要求每根总线上各串联有一个 $2.2k\Omega$ 的电阻

![[Pasted image 20210919015104.png]]

### 通讯节点
`CAN` 总线上可以挂载多个通讯节点，结点之间的信号经过总线传输，实现节点间通讯。由于 `CAN` 通讯协议不对节点进行地址编码，而是对数据内容进行编码，所以网络中的节点个数理论上不受限制，**只要总线的负载足够即可**，可以通过中继器增强负载  

`CAN` 通讯节点有一个 `CAN控制器` 和 `CAN收发器` 组成，控制器与收发器之间通过 `CAN_Tx` 和 `CAN_Rx` 信号线连接，收发器与CAN总线之间使用 `CAN_High` 和 `CAN_Low` 信号线相连，其中 `CAN_Tx` 和 `CAN_Rx` 使用普通的类似TTL逻辑信号，而 `CAN_High` 和 `CAN_Low` 是一对差分信号线，使用比较特别的**差分信号**

当CAN节点需要发送数据时，控制器把要发送的二进制编码通过 `CAN_Tx` 线发送到收发器，然后由收发器把普通的逻辑电平转化为差分信号，通过两条差分线输出到 `CAN` 网络，而通过收发器接收总线上的数据到控制器时，则是相反的过程，收发器总线上收到的 `CAN_High` 和 `CAN_Low` 信号转换为普通的逻辑电平信号，通过 `CAN_Rx` 输出到控制器中

### 差分信号
差分信号又称为差模信号，与传统使用的单跟信号线电压表示逻辑的方式有区别，使用差分信号传输时，需要了两根信号线，这两个信号线的振幅相等，相位相反，通过两根信号线的电压值来表示逻辑0和逻辑1  

#### 差分信号特点
+ 抗干扰能力强
+ 能够有效抑制外部的电磁干扰
+ 时序定位精确

由于差模信号的这些优点，在USB协议、485协议、以太网协议和CAN协议的物理层中，都使用了差分信号传输

### CAN协议中的差分信号
CAN协议中对它使用的 `CAN_High` 和 `CAN_Low` 表示的差分信号做出了规定  
以高速 `CAN` 协议为例子
+ 当表示逻辑1(隐性电平)时，CAN_High和CAN_Low线上的电压都是2.5v，即他们的电压差$V_H-V_L=0V$  
+ 当表示逻辑0时(显性电平)时，`CAN_High` 的电平为3.5V，`CAN_Low` 线的电平为1.5V，电压差为 $V_H-V_L=2V$

![[Pasted image 20210919022404.png]]

在 `CAN` 总线中，必须使它处于隐性电平或显性电平之中的一个状态，假如有两个 `CAN` 通讯节点，在同一时间，一个输出隐性电平，另一个输出显性电平，类似于 `I2C` 总线的 `线与` 特性将使它处于显性电平状态

CAN 通讯协议是半双工的通讯协议，无主从机的区分

## CAN协议层
`CAN` 协议层规定了通讯逻辑
### CAN的波特率和位同步
由于CAN属于异步通讯，没有时钟信号线，连接在同一个总线网络中的各个节点回想串口通讯那样，节点间使用约定好的波特率进行通讯，特别的，`CAN` 还会使用 `位同步` 的方式来抗干扰、吸收误差，实现对总线电平信号进行正确的采样，确保通讯正常

### 位时序分解
为了实现位同步，CAN协议把每一个数据为的时序分解成SS段、PTS段、PBS1段、PBS2段，这四段的长度加起来就是一个CAN数据位的长度  
分解后最小的时间单位是Tq，而一个完整的位通过8～25个Tq组成

![[Pasted image 20210919024014.png]]