# DCMI接口
## 简介
DCMI是STM32F4芯片自带的一个数字摄像头接口，该接口是一个同步并行接口，能够接收外部8位、10位、12位或14位 `CMOS` 摄像头模块发出的高速数据流  
可以支持不同的数据格式：YCbCr4：2：2/RGB565逐行视频和压缩数据(JPEG)

DCMI接口可以接收高速(可达54MB/s)的数据流，该接口包含多达14条数据线(D13-D0)和一条像素时钟线(PIXCLK)  
像素时钟的极性可编程，因此在像素时钟的上升沿或者下降沿捕获数据

## DCMI接口特点
+ 支持8位、10位、12位或14位并行接口
+ 支持内嵌码/外部行同步和帧同步
+ 支持连续模式和快照模式
+ 支持裁剪功能
+ 支持以下数据格式
	+ 8、10、12、14位逐行视频：单色或原始拜尔(Bayer)格式
	+ YCbCr 4:2:2逐行视频
	+ RGB565逐行视频
	+ 压缩数据 JPEG

## STM32 DCMI接口包括如下信号
1. 数据输入(D[0:13])，接摄像头的数据输出
2. 水平同步(行同步)输入(HSYNC)，接摄像头的HSYNC/HREF信号
3. 垂直同步(场同步)输入(VSYNC)，接摄像头的VSYNC信号
4. 像素时钟输入(PIXCLK)，接摄像头的PCLK信号

DCMI接口的数据与PIXCLK(即PCLK)保持同步，并根据像素时钟的极性在像素时钟上升沿和下降沿发生变化  
HSYNC(HREF)信号指示行的开始/结束，VSYNC信号指示帧的开始/结束  
时序基本和 ov2604 的时序一致

DCMI接收到数据，存储在DCMI_DR寄存器(32位)里面，摄像头 ov2640 采用8位数据宽度，所以每4个像素时钟，才会捕获完32位数据，第一个字节存放在LSB位置，第四个字节存放在MSB位置

| 字节地址 | 31:24          | 23:16          | 15：8          | 7：0           |
| -------- | -------------- | -------------- | -------------- | -------------- |
| 0        | $D_{n+3}$[7:0] | $D_{n+2}$[7:0] | $D_{n+1}$[7:0] | $D_{n}$[7:0]   |
| 4        | $D_{n+7}$[7:0] | $D_{n+6}$[7:0] | $D_{n+5}$[7:0] | $D_{n+4}$[7:0] |


## DCMI DMA说明
DCMI支持DMA传输，当DCMI_CR寄存器中的CAPTURE位置为1时，激活DMA接口  
像头接口每次在其寄存器(DCMI_DR)中收到一个完整的32位数据时，都将发送一个DMA请求，由DMA将DCMI_DR寄存器的值搬运到目的地址(比如LCD/SRAM等)

| 外设请求 | 数据流0 | 数据流1 | 数据流2                            | 数据流3         | 数据流4         | 数据流5         | 数据流6                            | 数据流7 |
| -------- | ------- | ------- | ---------------------------------- | --------------- | --------------- | --------------- | ---------------------------------- | ------- |
| 通道0    | ADC1    |         | TIM8_CH1</br>TIM8_CH2</br>TIM8_CH3 |                 | ADC1            |                 | TIM1_CH1</br>TIM1_CH2</br>TIM1_CH3 |         |
| 通道1    |         | DCMI    | ADC2                               | ADC2            |                 | $SPI6_TX^{(1)}$ | $SPI6_RX^{(1)}$                    | DCMI    |
| 通道2    | ADC3    | ADC3    |                                    | $SPI5_RX^{(1)}$ | $SPI5_TX^{(1)}$ | CRYP_OUT        | CRYP_IN                            | HASH_IN |


DCMI的DMA请求是映射在DMA2通道的通道1数据流上的，所以配置DMA时应该配置这个  
如果直接采用 DCMI --> DMA --> LCD 的传输方式，因为LCD是16位宽(RGB565)，而DCMI_DR是32位宽，所以一次DCMI引起的DMA传输，将引发王LCD写两次数据


## DCMI接口的初始化流程
+ 配置相关引脚的复用功能，时能DCMI时钟
+ 设置DCMI工作模式和PCLK/HSYNC/VSYNC等参数
	+ 根据ov2640模块的输出时序
	+ PCLK设置为上升沿有效
	+ HSYNC和VSYNC设置为下降沿有效
	+ 设置帧中断等参数
+ 设置DMA
+ 启动DCMI传输