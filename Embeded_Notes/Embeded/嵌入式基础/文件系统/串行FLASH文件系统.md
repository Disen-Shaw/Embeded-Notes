### 文件系统
![[Pasted image 20210310143508.png]]
数据在 PC上是以文件的形式储存在磁盘中的,这些数据的形式一般为 ASCII 码或二进制形式。

接存储数据会带来极大的不便,如难以记录有效数据的位置,难以确定存储介质的剩余空间,以及应以何种格式来解读数据，导致数据的存储杂乱，需要一些管理方式来管理数据

这些管理方式即为文件系统,它是为了存储和管理数据,而在存储介质建立的一种组织结构,这些结构包括操作系统引导区、目录和文件

常见的 windows 下的文件系统格式包括 FAT32、NTFS、exFAT，
在使用文件系统前,要先对存储介质进行格式化
格式化先擦除原来内容,在存储介质上新建一个文件分配表和目录
文件系统就可以记录数据存放的物理地址,剩余空间等信息

使用文件系统时, 数据都以文件的形式存储。
写入新文件时,先在目录中创建一个文件索引,指示文件存放的物理地址,再把数据存储到该地址中
当需要读取数据时,可以从目录中找到该文件的索引,进而在相应的地址中读取出数据
具体还涉及到逻辑地址、簇大小、不连续存储等一系列辅助结构或处理过程

文件系统的存在使我们在存取数据时,不再是简单地向某物理地址直接读写,而是要遵循它的读写格式。如经过逻辑转换,一个完整的文件可能被分开成多段存储到不连续的物理地址,使用目录或链表的方式来获知下一段的位置。

### FATFs 文件系统
文件系统庞大而复杂,它需要根据应用的文件系统格式而编写,而且一般与驱动层分离开来,很方便移植,所以工程应用中一般是移植现成的文件系统源码

FatFs 是面向小型嵌入式系统的一种通用的 FAT 文件系统。
它完全是由 ANSI C 语言编写并且完全独立于底层的 I/O 介质。
因此它可以很容易地不加修改地移植到其他的处理器当中
如 8051、PIC、AVR、SH、Z80、H8、ARM等

FatFs 支持 FAT12、FAT16、FAT32 等格式
把 FatFs 文件系统代码移植到工程之中,就可以利用文件系统的各种函数
对 SPI Flash 芯片以“文件”格式进行读写操作了

[FatFs 文件系统的源码可以从 fatfs 官网下载:](http://elm-chan.org/fsw/ff/00index_e.html)

![[Pasted image 20210310144156.png]]

+ option 文件夹下是一些可选的外部 c 文件,包含了多语言支持需要用到的文件和转换函数
+ diskio.c 文件是 FatFs 移植最关键的文件,它为文件系统提供了最底层的访问 SPI Flash芯片的方法,FatFs 有且仅有它需要用到与 SPI Flash 芯片相关的函数。
+ diskio.h 定义了FatFs 用到的宏,以及 diskio.c 文件内与底层硬件接口相关的函数声明
+ src 文件夹下的源码文件功能简介如下
	+ integer.h:文件中包含了一些数值类型定义。
	+ diskio.c:包含底层存储介质的操作函数,这些函数需要用户自己实现,主要添加底层驱动函数。
	+ ff.c: FatFs 核心文件,文件管理的实现方法。该文件独立于底层介质操作文件的函数,利用这些函数实现文件的读写
	+ cc936.c:本文件在 option 目录下,是简体中文支持所需要添加的文件,包含了简体中文的 GBK 和 Unicode 相互转换功能函数
	+ ffconf.h:这个头文件包含了对 FatFs 功能配置的宏定义,通过修改这些宏定义就可以裁剪 FatFs 的功能。如需要支持简体中文,需要把 ffconf.h 中的_CODE_PAGE的宏改成 936 并把上面的 cc936.c 文件加入到工程之中

建议阅读这些源码的顺序为:integer.h --> diskio.c --> ff.c

### FATFs程序框图
![[Pasted image 20210310144609.png]]

用户应用程序需要由用户编写,想实现什么功能就编写什么的程序,一般我们只编写
+ f_mount()
+ f_open()
+ f_write()
+ f_read()

就可以实现文件的读写操作

FatFs 组件是 FatFs 的主体,文件都在源码 src 文件夹中
其中 ff.c、ff.h、integer.h 以及diskio.h不需要改动
只需要修改 ffconf.h 和 diskio.c 两个文件
底层设备输入输出要求实现存储设备的读写操作函数、存储设备信息获取函数等等

### FATFs移植步骤
[[STM32_串行FLASH文件系统]]