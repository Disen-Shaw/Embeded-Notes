# LiteOS 中断管理
## 中断基本概念
中断是指出现需要时，CPU暂停执行当前程序，转而执行新程序的过程。即在程序运行过程中，出现了一个必须由CPU立即处理的事务。  
此时，CPU暂时中止当前程序的执行转而处理这个事务，这个过程就叫做中断。

外设可以在没有CPU介入的情况下完成一定的工作，但某些情况下也需要CPU为其执行一定的工作。  
通过中断机制，在外设不需要CPU介入时，CPU可以执行其它任务，而当外设需要CPU时，将通过产生中断信号使CPU立即中断当前任务来响应中断请求。这样可以使CPU避免把大量时间耗费在等待、查询外设状态的操作上，有效提高系统实时性以及执行效率。

## Huawei LiteOS 中断特性
+ 中断共享，且可以配置
+ 中断嵌套，即高优先级的中断可抢占低优先级的中断，且可配置
+ 使用独立中断栈，可配置
+ 可配置支持的中断优先级个数
+ 可配置支持的中断数

## 中断的硬件介绍
### 设备中断
发起中断的 中断信号源，当设备需要申请CPU的使用权时，产生一个中断信号  
该信号连接至中断控制器

### 中断控制起
中断控制器是CPU众多外设中的一个，它一方面接收其它外设中断引脚的输入，另一方面，它会发出中断信号给CPU ，可以通过对中断控制器编程来打开和关闭中断源、设置中断源的优先级和触发方式  
常用的中断控制器有VIC（Vector Interrupt Controller）和GIC（General Interrupt Controller）。

### CPU
CPU会响应中断源的请求，中断当前正在执行的任务，转而执行中断处理程序。

## 中断号的相关概念
### 中断号
每个中断请求信号都会有特定的标志，使得计算机能够判断是哪个设备提出的中断请求，这个标志就是中断号

### 中断请求
"紧急事件" 需向CPU提出申请（发一个电脉冲信号），要求中断，及要求CPU暂停当前执行的任务，转而处理该“紧急事件”，这一申请过程称为中断请求。

### 中断优先级
为使系统能够及时响应并处理所有中断，系统根据中断时间的重要性和紧迫程度，将中断源分为若干个级别，称作中断优先级

### 中断处理程序
当外设产生中断请求后，CPU暂停当前的任务，转而响应中断申请，即执行中断处理程序。产生中断的每个设备都有相应的中断处理程序

### 中断嵌套
中断嵌套也称为中断抢占，指的是正在执行一个中断处理程序时，如果有另一个优先级更高的中断源提出中断请求，这时会暂时终止当前正在执行的优先级较低的中断源的中断处理程序，转而去处理更高优先级的中断请求，待处理完毕，再返回到之前被中断的处理程序中继续执行

### 中断触发
中断源向中断控制器发送中断信号，中断控制器对中断进行仲裁，确定优先级，将中断信号送给CPU。中断源产生中断信号的时候，会将中断触发器置 "1"，表明该中断源产生了中断，要求CPU去响应该中断

### 中断触发类型
外部中断申请通过一个物理信号发送到NVIC/GIC，可以是电平触发或边沿触发。

###  中断向量
中断服务程序的入口地址

### 中断向量表
存储中断向量的存储区，中断向量与中断号对应，中断向量在中断向量表中按照中断号顺序存储

### 中断共享
当外设较少时，可以实现一个外设对应一个中断号，但为了支持更多的硬件设备，可以让多个设备共享一个中断号，共享同一个中断号的中断处理程序形成一个链表。当外部设备产生中断申请时，系统会遍历执行中断号对应的中断处理程序链表直到找到对应设备的中断处理程序。  
在遍历执行过程中，各中断处理程序可以通过检测设备ID，判断是否是这个中断处理程序对应的设备产生的中断。

### 核间中断
对于多核系统，中断控制器允许一个CPU的硬件线程去中断其他CPU的硬件线程，这种方式被称为核间中断。  
核间中断的实现基础是多CPU内存共享，采用核间中断可以减少某个CPU负荷过大，有效提升系统效率。  
目前只有GIC中断控制器支持。

## 运作机制
### Huawei LiteOS的中断机制支持中断共享
中断共享的实现依赖于链表，对应每一个中断号创建一个链表，链表节点中包含注册的中断处理函数和函数入参。当对同一中断号多次创建中断时，将中断处理函数和函数入参添加到中断号对应的链表中，因此当硬件产生中断时，通过中断号查找到其对应的链表，遍历执行链表直到找到对应设备的中断处理函数

### Huawei LiteOS的中断嵌套
+ GIC与NVIC的中断嵌套由硬件实现
+ RISC-V的中断嵌套实现机制为：
	+ 中断嵌套下，中断A触发后会将当前的操作进行压栈，调用中断处理程序前，将MIE设置为1，允许新的中断被响应。
	+ 在A执行中断处理程序的过程中，如果有更高优先级的中断B被触发，B 会将当前的操作即中断A相关的操作进行压栈，然后执行B的中断处理程序。
	+ 待B的中断处理程序执行完后，会暂时的将mstatus寄存器中的MIE域置为0，关闭中断响应，将中断A相关的操作进行出栈，将MIE设置为1，允许处理器再次响应中断，中断B结束，继续执行中断A。

[[LiteOS_中断管理_API]]