# 虚拟内存
## 虚拟内存的起因
**理想中的存储器**
*更大、更快、更便宜的非易失性存*储器

**实际中的存储器**
通过层级结构来将各个种类的存储器划分为不同的层级，以此来适配CPU的运算速度

内存不够用的情况，软件规模的速度远大于存储器容量的增长速度

将不常用的数据放在硬盘中，常用的放在内存中

## 内存不够的情况以及应对方法
### 程序太大，超过内存容量
可以采用手动的覆盖(overlay)技术，只把需要的指令和数据保存在内存中

### 程序太多，超过内存的容量
采用自动的交换技术(swapping)，把暂时不能执行的程序送到外存中

`如果想要在有限的内存中，以更小的页粒度为单位装入更大的程序，可以采用自动的虚拟存储技术` 

## 覆盖技术
在较小的可用内存中运行较大的程序，常用于多道程序系统，与分区存储管理配合

### 原理
把程序按照其自身逻辑结构，划分为若干个功能上相对独立的程序模块
那些不会同时执行的模块共享同一块区域，按时间先后的顺序运行
+ 必要部分(常用功能)的代码和数据常驻内存
	+ 常驻内存用于管理，将函数、数据倒入导出内存中
+ 可选部分(不常用功能)在其他程序模块中实现，平时存放在外存中，在需要到时才装入内存
+ 不存在调用关系的模块不同同时装入到内存，从而可以相互覆盖，即这些模块共用一个分区

例如：
![Pasted image 20210617010751](../../../../pictures/Pasted%20image%2020210617010751.png)
A为常驻内存
B、E、F没有调用关系，可以共同放置在一个50K的内存中
C、D没有调用关系，可以共同放置在一个30K的内存中
这样会省一些内存空间
### 特点
#### 优点
可以通过精心安排，在一块小的内存中运行较为庞大的程序

#### 缺点
有程序员把一个大的程序划分为若干个小的功能模块，并确定各个模块之间的覆盖关系，费时费力，增加变成难度
覆盖模块从外存装入内存，实际上是以时间延长来换取空间节省


## 交换技术
多道程序在内存中时，让正在运行的程序或需要运行的程序获得更多的内存资源

### 原理
+ 将暂时不能运行的程序送到外村中，从而获得空闲内存
+ 操作系统把一个进程的整个地址空间的内容保存到外存中(swap)，而将外存中的某个进程的地址空间读入到内存中(swap)
	+ 换入换出内容的大小为整个程序的地址空间


### 交换技术实现中的几个问题
+ 交换时机不确定：
	何时需要发生交换
	只当内存空间不够或者有不够的危险时换出	
	`一般对性能要求高的服务器不会允许交换`

+ 交换区的大小不确定
+ 程序换入时的位置的重定位
	+ 通过动态的地址映射


## 覆盖与交换的比较
覆盖只能发生在那些相互之间没有调用关系的程序模块之间，因此必须给出程序内各个模块之间的逻辑覆盖结构
交换技术以在内存中的程序大小为单位进行的，它不需要给出各个模块之间的逻辑覆盖结构
交换发生在内存中程序与管理程序或操作系统之间，而覆盖发生在运行程序的内部