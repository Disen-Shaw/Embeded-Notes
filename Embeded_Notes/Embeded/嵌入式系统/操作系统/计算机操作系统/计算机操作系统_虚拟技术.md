# 虚拟技术
虚拟内存管理技术
## 简介
### 虚拟内存技术存在的意义
在内存不够用的情况下，可以采用覆盖技术和交换技术，但是覆盖技术需要程序员自己把整个程序划分为若干个小的功能块，并确定模块之间的覆盖关系，增加了程序员的负担

而交换技术以进程作为交换的单位，需要把进程的整个地址空间都换进换出，增加了处理器的开销

虚拟内存技术像覆盖那样，不是把程序所有内容都放在内存中，因此能够运行比当前的空闲内存空间还要大的程序
但是虚存技术做的更好，有操作系统完成，无需人为的干预

![[Pasted image 20210617014530.png]]
例如P3只用到了两个内存页的内容，其他内容没有运行到，就将其他内容存放到硬盘中去

## 程序的局部性原理
程序在执行过程中的一个较短时期，所执行的指令地址和指令的操作数地址，分别局限于一定的区域

### 时间局部性
一条指令的一次执行和下次执行，一个数据的一次访问和下次访问都集中在一个较短的时间内

### 空间局部性
当前指令和附近的几条指令，当访问的数据和邻近的几个数据都集中在一个较小的区域内

程序的局部性表明，`从理论上`虚存技术是能够实现的，而且在实现之后效果会很好

## 虚存技术
可以在页式或段式内存管理的基础上实现
+ 在装入系统时，不必将其全部装入到内存中而只需要将当前需要执行的部分页面或段装入到内存中，就可以让程序运行
+ 在程序执行过程中，如果需要执行的指令或访问的数据尚在内存，则处理器同志操作系统将相应的页面或段调入到内存，然后继续运行
+ 操作系统将内存中暂时不使用的页面或段调出保存在外存上，从而腾出更多空闲空降将存放要装入程序以及要调入的页面或段

### 基本特征
#### 大的用户空间
通过把物理内存与外存相结合，提供给用户的虚拟内存空间通常大于实际内存的物理内存，即实现了两者的分离
如32位的虚拟地址理论上可以访问4GB，而可能计算机上仅有256M的物理内存，但是硬盘的容量大于4GB

#### 部分交换
与交换技术相比较，虚拟存储的调入和调出是相对部分虚拟地址空间进行的

#### 不连续性
物理内存的不连续，虚拟地址空间使用的不连续

## 实现
![[Pasted image 20210617022447.png]]
左边一栏为逻辑地址，右边一栏为物理地址
通过页表来进行映射
也表中有用于表现逻辑地址是否存在对应的物理地址的位
如果访问过程中逻辑地址对应的物理地址不存在，则会产生页读取异常
这个异常会被应用到虚拟内存

### 虚拟页式内存管理
大部分虚拟存储系统都采用虚拟页式存储管理技术，即在页式存储管理的基础上增加请求调页和页面置换功能

当一个用户程序要调入内存运行时，不是将程序的所有页面都装入内存，而是只装入部分的页面，就可以启动程序的运行
在运行的过程中，如果发现要运行的程序或要访问的数据不再内存，则向系统发出缺页请求，系统在处理这个中断时，将外存中相应的页面调入内存，使得该程序能够继续运行

![[Pasted image 20210617023451.png]]

**驻留位**
页是在内存还是外存
如果该为等于1,表示该页位于内存当中，即该页表项是有效的，可以使用
如果该位等于0,表示该页当前还在外存当中，如果访问该页表项，将导致页中断

**保护位**
表示允许对该页做何种类型的访问，如只读、可读写、可执行等

**修改位**
在此页中内存是否修改过
当系统回收该物理页时，根据此位来决定是否把它的内容写回外存
用于对比数据是否与硬盘中的数据相同

**访问位**
如果该页面被访问过(包括读写操作)，则设置此位
用于页面置换算法

![[Pasted image 20210617024529.png]]
缺页中断
![[Pasted image 20210617024558.png]]

## 后备存储
在何处保存未被映射的页
+ 能够简单识别在二级存储器中的页
+ 交换空间(磁盘或文件)：特殊格式，用于存储未被映射的页面

### 后备存储
+ 一个虚拟地址空间的页面可以倍映射到一个文件(在二级存储中)都某个位置
+ 代码段：映射到可执行文件
+ 动态加载的公想哭程序段：映射到动态调用的库文件
+ 其他段：可能被映射到交换文件(swap file)

### 虚拟内存性能
为了便于理解分页的开销，使用有效存储器访问时间
EAT=访问时间x页表命中几率x page fault处理时间x page fault几率
