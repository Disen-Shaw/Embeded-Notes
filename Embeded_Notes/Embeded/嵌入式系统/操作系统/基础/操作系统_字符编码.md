# 字符编码
+ [字符编码及转换测试网站](http://qqxiuzi.cn/daohang.htm)
+ [Unicode官网](http://www.unicode.org)

## 字符编码
由于计算机只能识别0和1,文字也只能以0和1的形式在计算机里存储，所以西药对文字进行编码才能让计算机处理，编码的过程就是规定特定的01数字串来便是特定的文字，最简单的字符编码例子就是 `ASCII` 码。

### ASCII编码
在程序设计中使用 `ASCII` 编码表约定了一些控制字符，英文及数字。它们在存储器中，本质是二进制数，只是约定了这些二进制数可以表示某些特定的含义，例如 `ASCII` 编码解释数字 "0x41" 时，表示英文字母 'A'

`ASCII` 码表分为两部分，第一部分是 `控制字符` 或者 `通讯专用` 字符，他们的数字编码从0～31,并没有特定的图形显示，但会根据不同的应用程序，而对文本显示有不同的影响。  
`ASCII` 码的第二部分包括空格，阿拉伯数字、标点符号、大小写英文字母以及 "DEL(删除控制)"，这部分符号的数字是32~127，除了最后一个DEL符号外，都能一图形的方式来表示，属于传统文字书写系统的一部分。

后来计算机引进其他国家时，由于语言的因素，本国使用的语言在 `ASCII` 码表中没有定义，所以就采用127还之后的位来表示这些新的字符，还加入了各种形状，一直编号到了255。从128到255这些字符被称为ASCII的拓展字符集，至此，基本存储单位 `Byte(char)` 能表示的编号都被用完了。

### 中文编码
英文书写系统都是由26个基本字母组成的，利用26个基本字母就可以足可处不同的单词，所以用 `ASCII` 码表就能表达整个英文书写系统。而中文书写系统中的汉字是独立的方块，若参考单词拆解成字母的表达方式，汉字可以拆解成 `部首`、`笔画` 来表示，但这样会非常复杂，类似于五笔输入法编码，所以以中文编码直接对方块字进行编码，一个汉字使用一个号码。

由于汉字非常多，常用就有6000多个，如果想 `ASCII` 编码表那样只是用一个字节最多只能表达256个汉字，所以中文编码使用2个字节来编码

#### GB2312标准
我国首先定义的是 `GB2312` 标准，他把 `ASCII` 码表127号之后的扩展字符集直接取消掉，并规定小于127的编码按原来 `ASCII` 标准解释字符，当2个大于127的字符连在一起时，就表示一个汉字，第一个字节使用(0xA1-0xFE)编码，第二个字节使用(0xA1-0xFE)编码，这样的编码组合起来表示了7000多个符号，其中包含6763个汉字。

在这些编码里，还把数学符号、罗马字符日文假名等都编进表中，就连原来在 `ASCII` 里原本就有的数字、标点和字母也重新变了两个字节的编码，这就是平时在输入法里可切换的 "全角" 字符，而标准的 `ASCII` 码表中127号以下的就被称为 "半角" 字符。

下表说明了 `GB2312` 是如何兼容 `ASCII` 码的，当设定使用 `GB2312` 标准的时候，他遇到一个字符串时，会按字节检测字符值的大小，若遇到连续两个字节数值都大于127的字符时，就把这两个连续的字节合在一起  
用 `GB2312` 解码，若遇到的数值小雨127,就直接用 `ASCII` 把它解码

| 第一字节 | 第二字节 | 表示的字符 |                    说明                    |
|:--------:|:--------:|:----------:|:------------------------------------------:|
|   0x68   |   0x69   |    (hi)    | 两个字节都小于127(0x7F)</br>使用ASCII解码  |
|   0xB0   |   0xA0   |    (啊)    | 两个字节都大于127(0x7F)</br>使用GB2312解码 |

##### 区位码
在 `GB2312` 编码实际使用中，有时会用到区位码的概念。  
`GB2312` 编码对所录字符进行了 "分界" 处理，公94个区，公8836个码位。而区位码实际是 `GB2312` 的内部形式，他规定对收录的每个字符采用两个字节表示，第一个字节为 "高字节"，对应94个区。第二个字节为 "地字节" ，对应94个位。  
所以他的区位码范围是：0101~9494

为兼容 `ASCII` 码，区号和位号分别加上0xA0便宜就得到 `GB2312` 的编码。  
在区位码上加上0xA0偏移，渴求的 `GB2312` 编码范围：0xA1A1~0xFEFE  
其中汉字的编码范围为：0xB0A1~0xF7FE，第一字节0xB0～0xF7(对应区号：16～87)，第二个字节0xA1~0xFE(对应位号：01~94)

#### GBK编码

> 有不少不认识的乱码文字就是这个里面的

据统计， `GB2312` 编码中表示的6763个汉字已经覆盖了中国大陆 99.75% 的使用率，但是不能因为有些字不常用就不让它进入信息时代，而且生僻字在人名、文言文等地方出现频率较高。  

为此在 `GB2312` 标准的基础上又增加了1420个新汉字(包括 `Big5` 中的所有汉字)和符号，这个方案被称为 `GBK` 标准。  

增加了海量的字符，按照 `GB2312` 编码的存储标准，两个字节已经存储不下，因此修改了存储的格式，不再要求原来2个字节的编码值必须大于127,只要第一个字节大于127,就表示这是一个汉字的开始。  
**这样就能够做到兼容 `ASCII` 和 `GB2312` 标准。**


#### GBK18030编码
随着计算机技术的普及，又在 `GBK` 的标准上不断扩展字符，这些便准被称为 `GB18030` ，如 `GB18030-2000` 、`GB18030-2005` 等(数字是制定标准的年号)， `GB18030` 的编码使用4个字节，他利用前面标准中的第二个字节未使用的 "0x30~0x39" 编码表示扩充四字节后缀，兼容 `GBK` 、 `GB2312` 以及 `ASCII` 编码标准。  

`GB18030-2000` 主要在 `GBK` 的基础上增加了 " `CJK` (中日韩)统一汉字扩充A" 的汉字。加上前面的 `GBK` 内容，`GB18030` 一共规定了27533个汉字(包括部首、部件等)的编码，还有一些常用的非汉字符号。  

`GB18030-2005` 主要特点是在 `GB18030-2000` 的基础上增加了 " `CJK` (中日韩)统一汉字扩充B" 的汉字。增加了42711个汉字和我国少数闵子文字的编码(如藏族、蒙古族、傣族、彝族、朝鲜族、维吾尔族等)。  
加上之前 `GB18030-2000` 的内容，一共收录了70244个汉字。

#### Big5编码
在台湾、香港地区，使用较多的是 `Big5` 编码，它的主要特点是收录了繁体字。而从 `GBK` 编码开始，已经把Big5中的所有汉字收录进编码了。但是两个标准的编码是不一样的，两个标准不兼容。


### Unicode
由于各个国家和地区根据使用自己文字系统制定标准，同一个编码在不同的标准里表示不一样的字符，各个标准不兼容，而又没有一个标准能够囊括所有的字符，即无法用一个标准表达所有的字符。

国际标准化组织(ISO)为了解决这样一个问题，舍弃了地区性的方案，重新给全球所有文化使用的字母和符号进行编号，对每个字符指定一个唯一的编号(ASCII中原有的字符编号不变)，这些字符号码从 0x000000 到 0x10FFFF ，该编号集被称为 `Unicode` 。  

最新版的 `Unicode` 标准还包含了表情符号(聊天中的部分emoji表情)，可访问`Unicode` 官网了解。

`Unicode` 字符集只是对字符进行编号，但具体怎么对每个字符进行编码， `Unicode` 并没有指定，因此也衍生出了如下几种 `Unicode` 编码方案(Unicode Transformation Format)。

#### UTF-32
对 `Unicode` 字符集编码，最自然的就是 `UTF-32` 方式了，编码时，他直接对 `Unicode` 字符集里的每个字符都用4个字节表示，转换方式很简单，直接将字符对应的编号数字转换为4字节的二进制数。

由于 `UTF-32` 把每个字符都要用四个字节存储，因此 `UTF-32` 不兼容 `ASCII` 编码，也就是说 `ASCII` 编码文件用 `UTF-32` 标准来打开会成为乱码。

| 字符 | GBK编码 | Unicode编码 | UTF-32编码          |
| ---- | ------- | ----------- | ------------------- |
| A    | 0x41    | 0x0000 0041 | 大端格式0x0000 0041 |
| 啊   | 0xB0A1  | 0x000055A4  | 大端格式0x0000554A  |

#### UTF-16
针对 `UTF-32` 的缺点，人们改进出了 `UTF-16` 的编码方式，它采用2字节或者4字节的变长编码方式(UTF-32定长为4字节)。对 `Unicode` 字符编号在0到65535的统一用2个字节来表示，将每个字符的编号转换为2字节的二进制数，即从0x0000到0xFFFF。

而由于 `Unicode` 字符集在0xD800~0xDBFF这个区间是没有表示任何字符的，所以 `UTF-16` 就利用这段空间，对 `Unicode` 中标号超出0xFFFF的字符，利用他们的编号做某种运算与该空间建立映射关系，从而利用该空间表示4字节扩展

| 字符 | GB18030编码 | Unicode编号 | UTF-16编码          |
| ---- | ----------- | ----------- | ------------------- |
| A    | 0x41        | 0x0000 0041 | 大端格式0x0041      |
| 啊   | 0xB0A1      | 0x0000 554A | 大端格式0x554A      |
| x    | 0x9735 F832 | 0x0002 75CC | 大端格式0xD85D DDCC |

`UTF-16` 解码时，按两个字节去读取，如果这两个字节不再0xD800到0xDFFF范围内，那就是双字节编码的字符，以双字节进行解析，找到对应编号的字符，如果这两个字节在0xD800到0xDFFF之间，那他就是四字节编码的字符，以四字节进行解析，找到对应编号的字符。

`UTF-16` 编码的优点是相对 `UTF-32` 节约了存储空间，缺点是仍不兼容 `ASCII` 码，**仍有大小端格式问题。**

#### UTF-8
`UTF-8` 是目前 `Unicode` 字符集中使用最广泛的编码方式，目前大部分网页文件一使用 `UF-8` 编码，如使用浏览器查看百度首页源文件，可以在前几行HTML代码中找到 `UTF-8`

`UTF-8` 也是一种变长的编码方式，它的编码有1、2、3、4字节长度的方式，每个 `Unicode` 字符根据自己的编号范围去进行对应的编码。  

它的编码符合以下规律：
+ 对于 `UTF-8` 单字节的编码，该字节的第一位设为0(从左边数起第一位，即最高位)，生育的位用于写入字符的 `Unicode` 编号。即对于 `Unicode` 标号从 0x0000 0000~0x0000 007F的字符， `UTF-8`编码只需要一个字节，因为这个范围 `Unicode` 编号的字符与 `ASCII` 码完全相同，所以 `UTF-8` 兼容了 `ASCII码表`
+ 对于 `UTF-8` 使用N个字节的编码(N>1)，第一个字节的前N位设为1,地N+1位设为0,后面的两位都设为10,这N个字节的其余空位填充该字符的 `Unicode` 标号，高位用0补足。

**Unicode(16进制)**

| 编号范围          | 第一字节  | 第二字节 | 第三字节 | 地四字节 | 第五字节 |
| :-----------------: | --------- | -------- | -------- | -------- | -------- |
| 00000000~0000007F | 0xxxxxxxx |          |          |          |          |
| 00000080~000007FF | 110xxxxx  | 10xxxxxx |          |          |          |
| 00000800~0000FFFF | 1110xxxx  | 10xxxxxx | 10xxxxxx |          |          |
| 00010000~0010FFFF | 11110xxx  | 10xxxxxx | 10xxxxxx | 10xxxxxx |          |
| ...               | 111110xx  | 10xxxxxx | 10xxxxxx | 10xxxxxx | 10xxxxxx |

`UTF-8` 解码的时候以字节为单位去看，如果第一个字节的bit位一0开头，那就是 `ASCII` 字符，以但字节进行解析。如果第一个字节的数据位以 "110" 开头，以双字节解析...


## 字模
有了编码，就能在计算机中处理、存储字符了，但是如果计算机处理完字符后直接以编码的形势输出，人类将难以识别。因此计算机与人交互时，一般会将字符转化成人类习惯的表现形势进行输出，如现实、打印的时候。  

但是如果仅有字符编码，计算机还不知道该如何表达该字符，因为字符实际上是一个个独特的图形，**计算机必须吧字符编码转化成对应的字符图形，人类才能正常识别，因此要给计算机提供字符的图形数据，这些数据就是字模**，多个字模数字组成的文件也称位字库。

计算机现实字符时，根据字符编码与字模数据的映射关系找到它对应的字模数据，液晶屏根据字模数据现实该字符。

### 字模的构成
一直字模是图形数据，而图形在计算机中是由一个个像素点组成的，所以字模实际上是一个个像素点的数据。为了方便处理，吧字模定义成方块性的像素点阵，而每个像素点之后i后0和1这两种状态(可以理解为单色图像数据)。

下面是两个宽、高为16\*16的像素点阵组成的两个汉字图形，其中的黑色像素点即为文字的笔迹。  
计算机要表示这样的图形，之需要使用16x16而二进制数据位，每个数据位记录一个像素点的状态，把黑色像素短以 '1' 表示，无色像素点以0表示既可。

![Pasted image 20210811052507](../../../../pictures/Pasted%20image%2020210811052507.png)

16x16的 字 的字模数据以C语言数组的方式表示，见下面的代码。以两个字节表示一个像素点，16行构成一个字模。

```c
unsigned char code Bmp003[]={
// 16
0x02,0x00,0x01,0x00,0x3f,0xfc,0x20,0x04,0x40,0x08,0x1f,0xe0,0x00,0x40,0x00,0x80,
// 16 
0xFF,0xFF,0x7F,0xFE,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x05,0x00,0x02,0x00
};
```

 ### 制作字模
为了使用方便，需要制作所有常用的字模，如程序只需要英文显示，就需要制作包含 `ASCII` 码表中所有字符的字模，如程序只需要使用一些常用的汉字，则就可以选择制作 `GB2312` 编码里所有的字符的字模，而且希望字模数据与字符数据有固定的映射关系，方便后续使用字符编码作为索引，查找字模。
 
Windows平台软件 `PCtoLCD` 软件可以制作字模
 
使用字模软件制作的字模数据一般按照编码格式排列，如果利用软件生成的字模中的数据，是根据 `GB2312` 的区位码表的顺序存储的，它存储了区位码为 0101～9494 的字符，每个字模的大小为16×16/8 = 32个字节。  
其中第一个字符 "空格" 的区位码为 `0101` ，它是首个字符，所以文件的前36个字节是它的字模数据。同理， 36～72 字节存储的则是 0102 字符 "、"的字模数据。  
因此 可以导出任意字符的寻址公式：
$$Addr = (((Code_H-0xA0-1)×94)+(Code_L-0xA0-1))×16×16/8$$  

其中 
+ $Code_H$ 和 $Code_L$ 分别时 `GB2312` 编码的第一个字节和第二个字节。
+ 94指的是一个区中有94个位(94个字符)。
+ 16×16是每个字由16位长和16位宽组成的

软件生成的 `.FON` 后缀的文件比较大，甚至比一般的 MCU 的 内部Flash内存还要大，因此如果把字符编码文件直接存储在芯片的内部Flash中，MCU内部资源会非常紧张。  

一般的做法是将字模的编码数据存储在外部存储器中，如SD卡或者SPI-FLASH中，当需要现实某个字符的时候，控制器根据字符的编码算好字模的存储地址，再从存储器中读取，而Flash芯片在生产前就古画好了字模内容，然后直接吧Flash芯片铁道电路板上，最为整个系统的一部分。





