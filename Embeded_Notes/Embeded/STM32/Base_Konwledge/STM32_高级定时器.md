
# STM32_高级定时器
## 高级控制定时器TIM1和TIM8
### 基本介绍
![[Pasted image 20210402133148.png]]
**位于高速总线APB2上，内部时钟可达到系统时钟72MHz**
**16位计数器，可以实现**d
+ 向上、向下、中心对齐计数模式
+ 自动重装载计数器

**4个16位高精度捕捉比较通道**
可以编程设定通道捕捉比较通道：
+ 输出比较
+ PWM
+ 输入捕获、PWM输入捕捉
+ 单脉冲模式

**死区时间可编程的互补输出(通道和互补通道)**
**刹车输入信号可以将定时器输出信号置于复位状态或者一个已知状态**

**同步**
+ 定时器主设备/从设备同步
+ 与外部触发同步
+ 触发或门控模式

**针对定位的增量(正交)编码器和霍尔传感器接口**
独立的IRQ/DMA请求生成器
+ 更新事件
+ 输出比较
+ 输入捕获
+ 刹车信号输入(电机相关)
#### 功能引脚分部
![[Pasted image 20210402133414.png]]

### 时钟源
高级控制定时器有四个时钟源
#### 内部时钟源CK_INT
内部时钟来自芯片内部，等于72MHz，一般情况下使用内部时钟
![[Pasted image 20210402135628.png]]


#### 外部时钟模式1：当TIMx_SMCR寄存器的SMS=111时
功能框图：  
![[Pasted image 20210402135739.png]]
##### 时钟信号输入引脚
使用外部时钟模式1,有4个来自于**定时器通道**的时钟信号，分别是
TI1/2/3/4(TIMx_CH1/2/3/4)，配置TIM_CCMx的位CCxS\[1:0]来选择哪一路信号，其中CCM1控制TI1、2，CCM2控制TI3、4
##### 滤波器
作用简单，为了吕出输入信号上的高频干扰
##### 边沿检测
来自滤波后的信号，为了检测上升沿有效还是下降沿有效，具体由TIMx_CCER的位CCxP和CCxNP配置
##### 触发选择
若选择外部时钟模式1,此时有两个触发源
一个是滤波后的定时器输入1(TI1FP1)
一个是滤波后的定时器输入2(TI2FP2)
具体的有TIMx_SMCR的位TS\[2:0]配置
##### 从模式选择
选定了触发源信号后，信号是接到TRGI引脚的，让触发信号称为外部时钟模式1的输入，即CK_PSC


#### 外部时钟模式2(当TIMx_SMCR寄存器的ECE=1)
![[Pasted image 20210402202116.png]]
##### 时钟信号输入引脚
使用外部时钟模式2时，时钟信号来自于定时器特定的输入通道TIM_ETR
##### 外部触发极性
选择ETR上升沿检测，置TIMx_SMCR寄存器中的ETP = 0；
##### 分频器
当触发信号的频率很高时，就必须使用分频器进行降频
有1、2、4、8可以选择，是由TIMx_SMCR寄存器中的ETPS\[1:0]配置
##### 滤波器
如果ETRP的喜好的频率过高或者混杂有高频干扰信号的话，就需要用滤波器对ETRP信号进行重新采样，打到降频或者去除干扰的目的
由TIMx_SMCR的ETF\[3:0]配置，其中fdts是有内部时钟CK_INT分频得到的，有TIMx_CR1的位CKD\[1:0]配置
##### 从模式选择
静滤波后的信号连接至ETRF引脚，
CK_PSC输出，
驱动器计数
由TIMx_SMCR的位ECE置1即可配置为外部时钟模式2

#### 内部触发输入
定时器可以由另一个定时器而触发
主模式的定时器可以对从模式定时器执行复位、启动、停止或者提供时钟
![[Pasted image 20210402203554.png]]

### 控制器
高级控制定时器去哦那个志气部分包括触发控制器、从模式控制器以编码器接口
触发控制器用来针对内外设输出触发信号，比如为其他定时器提供时钟和触发DAC/ADC转换
编码器接口专门针对编码器计数而设计
从模式控制器可以控制计数器复位、启动、递增递减、计数
![[Pasted image 20210402204948.png]]


### 时基单元
高级控制定时器主要部分是一个16位计数器和与其相关的自我装载寄存器
预分频器分频得到的计数器可以向上、向下、中心对齐双向计数
时基单元包括
+ 计数器寄存器
+ 预分频寄存器
+ 自动重装载寄存器
+ 重复次数寄存器

![[Pasted image 20210402210504.png]]

#### 计数器CNT
##### 向上计数模式
计数器从0开始计数到自动重装载值(TIMx_ARR计数器的内容)，然后重新开始计数，并产生一个计数器溢出事件。
如果是用了重复计数器功能，在向上计数打到设置的重复计数次数(TIM_RCR)时，就会产生更新事件，否则每次计数器溢出才会产生更新事件
##### 向下计数模式
计数器从自动重装载值(TIMx_ARR)开始递减至0,然后重新自动重装载值开始递减并生成计数器下溢事件，如此循环
如果使用了重复计数器功能，在向下计数重复了重复计数寄存器(TIMx_RCR)中设定的次数后，将产生更新事件，否则每次计数器下溢时才产生更新事件
##### 中心对齐计数模式
计数器从0开始计数到自动加载的值(ARR)-1,产生一个计数器溢出事件，然后向下计数到1并且产生一个计数器下溢事件，又从0开始重新计数，如此循环。
每次上溢出和下溢出都会生成更新事件，当发生更新事件时，所有的寄存器值都被更新
![[Pasted image 20210402213946.png]]

#### 自动重装载寄存器ARR
自动重装载寄存器的值是预先装载的，当写或者读自动吃那个装载寄存器将访问预装载寄存
控制TIMx_CR1寄存器中的自动重装载预装载使能为(ARPE)
如果置1,预装载寄存器的内容在每次更新事件时传递给影子寄存器
如果是0,修改TIMx_ARR的 值后马上就会有效

#### 重复次数寄存器
高级定时器相比于基本和通用定时器多了重复计数器，在基本和通用定时器上溢或者下溢直接产生更新事件，而高级控制定时器只能在重复次数达到0的时候才会产生更新事件
这对PWM信号非常有用
重复计数器是自动加载的，当向上溢出、向下溢出和中央对齐模式下每次上溢出或者下溢出时，重复寄存器的值递减

在每N次计数上溢出或者下溢出时，数据从预装载寄存器传输到影子寄存器，(TIMx_ARR自动重装载入寄存器，TIM_PSC预装载寄存器，还有在比较模式下的捕获/比较寄存器TIMx_CCRx),N是TIMx_RCR重复寄存器中的值

![[Pasted image 20210402220214.png]]

### 捕获/比较
每一个捕获/比较通道都是围绕一个捕获/比较寄存器(包含了影子寄存器)，包含输入部分和输出部分
输入部分有数字滤波、多路复用和预分频
输出部分有比较器和输出控制
![[Pasted image 20210402222622.png]]
#### 输入捕获
输入部分对相应的TIx输入信号进行采样，滤波后产生一个信号TIxF。然后一个带**极性选择**的**边缘检测器**产生一个信号(TIxFPx),它可以作为从模式控制器的输入触发或者作为捕获控制，最后信号预分频进入捕获寄存器
![[Pasted image 20210403182307.png]]
输入捕获模式下，当检测到ICx信号山公园的响应边沿后，计数器的当前值被所存到捕获比较寄存器(TIMx_CCRx)中，如果开启了中断或者DMA请求，将产生中断或者DMA请求

如果发生捕获事件时CCxIF标志已经为高，那么重复捕获标志CCxOF(TIMx_SR寄存器)被置1,写CCxIF=0可清除CCxIF，或读取存储在TIMx_CCRx寄存器中的捕获数据也可以清除CCxIF
写CCxOF=0可以清除CCxOF

#### PWM输入模式
用定时器功能检查PWM波的**频率**和**占空比**
PWM输入模式是定时器输入模式的一种特例

+ 两个ICx信号被映射到同一个TIx输入
+ 两个ICx信号为边沿有效，但是极性相反
+ 其中一个TIxFP信号被作为触发输入信号，而从模式控制器被配置为复位模式

##### PWM时序图
PWM信号经由TI1进入，配置TI1FP1为出发信号，上升沿捕获
当上升沿的时候，IC1和IC2同事捕获，计数器CNT清零
到下降沿，IC2捕获，此时计数器CNT的值被锁存到捕获寄存器CCR2中
到了下一个上升沿的时候，IC捕获,计数器CNT的值被锁存到捕获寄存器CCR1中
其中CCR2测量的是脉宽、CCR1测量的是周期
![[Pasted image 20210403192617.png]]

### 输出比较
通过定时器去的外部引脚**对外输出控制信号**，可以设置成不同的模式
有冻结、将通道X(X = 1,2,3,4)设置成匹配时输出有效电平
将通道x设置成匹配时输出无效电瓶、电平翻转、强制为无效电平、强制为有效电平、PWM1和PWM2这6种模式
具体有寄存器OcxM\[2:0]设置

输出部分有比较器，当CNT的值跟比较寄存器的值相等时，输出参考信号OCxREF的信号极性就会改变，**其中OCxREF=1称为有效电平，OCxREF=0称为无效电平**，并且会产生比较中断CCxI相应的标志位CCxIF(SR寄存器中)会置位，然后OCxREF再经过一系列的控制之后就成为输出信号OCx/OcxN。

**输出部分产生一个中间波形OCxREF(高有效)作为基准，链的末端就定最终输出信号的极性**

![[Pasted image 20210403195045.png]]
![[Pasted image 20210403195054.png]]
第四通道
![[Pasted image 20210403195936.png]]
输出模式控制器，参考信号OCxREF在经过**死区发生器**之后会产生两路带死区互补信号OCx_DT和OCxN_DT(通道1~3才有互补信号，通道4没有)，这两路带死区的互补信号进入输出控制电路，如果没有加入死区控制，进入控制电路的信号就直接是OCxREF

#### 强制输出模式
输出模式(TIMx_CCMRx寄存器的CCxS位配置为00)下，**输出比较信号能够直接有软件强制为有效或者无效状态**，而不依赖于输出比较寄存器和计数器之间的**比较结果**
在这种模式下，在TIMx_CCRx影子寄存器和计数器直接的比较扔在进行，相应的标志也会被修改，因此仍然会产生相应的中断和DMA请求



#### 比较输出模式
用来控制一个**输出波形**或者指示一段**给定的时间已经到时**
当计数器与捕获/比较寄存器的内容相同时，输出比较功能做如下操作
+ 将输出比较模式(TIMx_CCMRx寄存器中的OCxM位)和输出极性(TIMx_CCER寄存器中的CCxP位)定义的值输出到相应的引脚上。
  在比较匹配时，输出引脚可以**保持它的电瓶(OCxM=000)**、**被设置成有效电瓶(OCxM=001)**、**被设置成无效电平(OCxM=010)**或**进行翻转(OCxM=011)**.
+ 设置中断状态寄存器中的标志位(TIMx_SR寄存器中的CCxIF位)
+ 若设置了相应的中断屏蔽(TIMx_DIER寄存器中的CCxIE位)，则产生一个中断
+ 若设置了相应的使能位(TIMx_DIER寄存器中的CCxDE位，TIMx_CR2寄存器中的CCDS位选择DMA请求功能)，则产生一个DMA请求

TIMx_CCMRx中的OCxPE位选择TIMx_CCRx寄存器是否需要使用预装载寄存器
在输出比较模式下，更新事件UEV对OCxREF和OCx输出没影响

**比较模式配置配置步骤：**
1. 选择计数器时钟(内部，外部，预分频器)
2. 将相应的数据写入TIMx_ARR和TIMx_CCRx寄存器中
3. 如果要产生一个中断请求，设置CCxIE位
4. 选择输出模式，例如
	+ 要求计数器与CCRx匹配时翻转OCx的输出引脚，设置OCxM=011
	+ 置OCxPE = 0 禁用预装载寄存器
	+ 置CCxP=0选择极性为高电平有效
	+ 置CCxE=1使能输出
5. 设置TIMx_CR1寄存器的CEN位启动计数器

TIMx_CCRx寄存器能够在任何时候通过**软件进行更新以控制输出波形**，条件是未使用预装载寄存器(OCxPE=0，否则TIMx_CCRx的影子寄存器只能在发生下一次更新事件时被更新)
输出比较模式时序图
![[Pasted image 20210403202810.png]]

#### PWM模式
PWM模式可以产生一个
由TIMx_ARR寄存器确定**频率(周期)**
由**TIM_CCRx**寄存器确定**占空比**的信号

STM32的PWM模式有两种
根据TIMx_CCMRx寄存器中的OCxM位来确定
110为模式1
111为模式2
##### PWM模式1：
在向上计数时，TIMx_CNT<TIMx_CCR1时通道1为有效电平，否则为无效电平
在向下计数时，TIMx_CNT>TIMx_CCR1时通道1为无效电平，否则为有效电平
##### PWM模式2：
在向上计数时，TIMx_CNT<TIMx_CCR1时通道1为无效电平，否则为有效电平
在向下计数时，TIMx_CNT>TIMx_CCR1时通道1为有效电平，否则为无效电平


根据TIMx_CR1寄存器中**CM5**位的状态，定时器能够产生边沿对齐的PWM信号或者**中央对齐**的PWM信号
一般的**直流有刷电机控制用的都是边沿对齐模式**，**无刷电机一般是用中央对齐模式**

**PWM边沿对齐模式**
计数器CNT只工作在**递增**或者**递减**其中一种模式下
例ARR=8,CCR=4,计数器从0开始计数
当CNT<CCR的值时，OCxREF为有效的高电平，此时比较中断寄存器CCxIF清零
当CCR<=CNT<=ARR时，OCxREF为有效的低电平，比较中断寄存器CCxIF置位，然后计数器CNT又开始从0计数，并生成上溢事件，这样不断循环
![[Pasted image 20210403204746.png]] 

**PWM中心对齐模式**
在中心对齐模式下(ARR=8)，计数器CNT是工作在递减/递增模式下
![[Pasted image 20210403210830.png]]
计数器CNT从0开始计数到自动重装载值-1(ARR-1),生成计数器上溢，然后从自动重装载值开始向下计数到1,生成计数器下溢事件，之后从0开始，如此循环

第一阶段(1,2)计数器CNT在递增模式下，从0开始计数，当CNT<CCR的值时，OCxREF为有效的高电平，当CCR<=CNT<ARR时，OCxREF为无效的低电平。

第二阶段(3,4)，计数器CNT在递减模式，从ARR值开始递减，当CNT>CRR时，OCxREF为无效的低电平，当CCR=>CNT=>1时，OCxREF为有效的高电平

中央对齐模式可以分为三种，根据CMS位的不同，比较中断的标志可以在向上计数时被置1，在计数器向下计数时被置1,或者在计数器向上和向下计数时被置1

### 互补输出和死区插入
#### 死区
大功率电机、变频器等，末端都是由大功率MOS管、IGBT等元件组成的**H桥**或者**三相桥**每个桥的上半桥臂和下半桥臂都是**绝对不能同时导通的**，但是高速的PWM驱动信号在打到功率原件的控制极时，往往会由于各种各样的原因**产生延迟的效果**，造成某个桥原件在应该关闭时没有关掉，造成功率元件烧毁

死区时在**上半桥关断**后，延迟一段时间**再打开下半桥**或者在下半桥关断后延迟一段时间再打开上半桥，从而避免功率原件烧毁
**这段延迟时间就是死区**

死区是PWM输出时为了使H桥或半H桥上下管不会因为开关速度问题而发生同时导通而设计的一个保护时段，所以在这个时间里，**上管下管都不会有输出**，会使波形输出中断，死区时间一般只占百分之几的周期，但是PWM波本身占空比小时，空出的部分比死区还大，所以死区会影响输出的纹波，但应该不是起到决定性作用的
![[Pasted image 20210403214748.png]]

### 互补输出和死区插入
**高级控制定时器**能够输出两路互补信号，并且能够管理输出的瞬时关断和接通，这段时间通常被称为死区，用户应根据连接的输出器件和它们的特性(端平转换的延时、电源开关的延时等)来调节死区的时间

配置TIM_CCER寄存器中的CCxP和CCxNP位，可以为**每一个输出独立的选择极性**(电瓶转换的延时，电源开关的延时等)来调节死区时间

配置TIMx_CCER寄存器中的CCxP和CCNP位，可以为**每一个输出独立的选择极性**(主输出OCx或互补输出OCxN)
互补信号OCx和OCxN通过下列控制位的组合进行控制：
TIMx_CCER基础起的CCxE和CCxNE位，TIMx_BDTR和TIMx_CR2寄存器中的MOE、OISx、OISxN、OOSI和OSSR位，带刹车工鞥的互补输出通道OCx和OCxN的控制位。特别在转换到IDLE状态时(MOE下降到0)死区被激活。
设置**CCxE和CCxNE**位将插入**死区**，如果存在**刹车电路**，则还要设置**MOE位**每一个通道都有一个10位的死区发生器
参考信号OCxREF可以产生2路输出OCx和OCxN。
如果OCx和OCxN为高有效：
+ OCx输出信号与参考信号相同，知识它的上升沿相当于参考信号的上升沿有一个延迟
+ OCxN输出信号与参考信号相反，只是它的上升沿相对于参考信号的下降沿有一个延迟

**每一个通道的死区延时都是相同的**，是由TIMx_BDTR寄存器中的DTG位编程配置
![[Pasted image 20210403221354.png]]
保证H桥电路不会短路

### 刹车功能
刹车功能
相当于手刹，用于**紧急制动**，关闭PWM输出，并且把通道输出锁定在安全输出状态(输出信号置于复位状态或者一个可知状态)
当使用刹车功能时，一句相应的控制位(TIMx_BDTR寄存器中的MOE、OSSI、OSSR位，TIMx_CR2寄存器中的OISx和OISxN位)，**输出使能信号和无效电平都会被修改**

MCU系统复位后，刹车电路被禁止，MOE位为低
设置TIM1_BDTR寄存器中的**BKE位**可以使能刹车功能
刹车输入信号的极性可以通过配置同一个寄存器中的**BKP位**选择
BKE和BKP可以被同时修改
![[Pasted image 20210403222459.png]]

当刹车发生时，有以下动作
MOE位被**异步**地**清除**，将输出置于无效状态、空闲状态或者复位状态(由OSSI位选择)，这个特性在MCU振荡器关闭时仍然有效

一旦MOE=0,每一个输出通道输出由TIMx_CR2寄存器中的OISx位设定的电平。如果OSSI=0,则定时器释放使能输出，否则输出始终为高

当时用**互补输出**时：
+ 输出首先被置于**复位状态**，即无效的状态(取决于极性)，这是异步操作，计时定时器没有时钟时，此功能也有效
+ 如果定时器的时钟依然存在，**死区生成器会重新生效**，在失去之后根据**OISx和OISxN位指示的电平驱动输出端口**。即使在这种情况下，OCx和OCxN也不能被同时驱动到有效的电平
  因**重新同步MOE**，死区时间比通常情况下长一些(大约2个ck_tim时钟周期)
  
+ 如果**OSSI=0**,**定时器释放使能输出**，否则保持使能输出；或一旦CCxE与CCxNE之一变高时，使能输出变高

如果设置了TIMx_DIER寄存器中的**BIE位**，当刹车状态标志(TIMx_SR寄存器的**BIF位**)为1时，则产生一个**中断**，如果设置了TIMx_DIER寄存器中的**BDE位**，则产生一个**DMA请求**。

如果设置了TIMx_BDTR寄存器中的**AOE位**，在**下一个更新事件UEV位会被自动置位**
例如可以用来进行整形，否则MOE时钟保持低知道被再次置1，此时这个特性可以被用在安全方面，可以吧刹车输入连接到电源驱动的报警输出、热敏传感器或者其他安全器件上

刹车响应输出
![[Pasted image 20210403224354.png]]
![[Pasted image 20210403224407.png]]

### 输出通道控制位
TIMx_BDTR：
MOE：主输出使能
OSSI：空闲模式下"关闭状态"选择
OSSR：运行模式下"关闭状态"选择
TIMx_CCER：
CCxE：输入/捕获x输出使能
CCxNE：输入/捕获1互补输出使能
以下位只管输出，捕获时没用
![[Pasted image 20210403225247.png]]
刹车
![[Pasted image 20210403230248.png]]


### 在外部事件时清除OCxREF信号
对于一个给定的通道，设置TIMx_CCMRx寄存器中对应的OCxCE位为1,能够用**ETRF**输入端的高电平把**OCxREF信号拉低**，OCxREF信号将保持为低，直到发生下一次更新事件UEV
只能用于**输出比较**和**PWM模式**
![[Pasted image 20210404164537.png]]
例如，**ETR信号**可以连到一个比较器的输出，用于控制电流
此时ETR配置如下：
1. 外部触发预分频控制器必须处于关闭状态：TIMx_SMCR寄存器中的ETPS\[1:0]=00
2. 必须**禁止外部时钟模式2**：TIMx_SMCR寄存器中的ECE=0
3. 外部出发**极性**(ETP)和外部出发**滤波器**(ETF)可以根据需要配置

![[Pasted image 20210404173151.png]]

### 产生六步PWM输出
常用于无刷电机驱动
COM事件：捕获/比较事件，产生控制更新、
为1时：当CCPC=1,允许自我更新CCxE、CCxNE、OCxM位
空过COM时间可以同时更新三个互补通道的配置，解决软件编程**只能一次设置一个互补通道**配置的问题

当在一个通道上需要互补输出时，预装载位有OCxM、CCxE、CCxNE
在发生COM换相事件时，这些预装载位会被送到影子寄存器位
这样就可以预先设置好下一步配置，并在同一时刻**同时修改所有的通道配置**
COM可以通过设置TIMx_EGR寄存器的COM位由软件产生，或在TRGI上升沿由硬件产生

当发生COM事件时会设置一个标志位(TIMx_SR寄存器中的COMIF位)，这时如果已经设置了TIMx_DIER寄存器的COMIE位，则产生一个中断
如果设置了TIMx_DIER寄存器的COMDE位，则产生一个DMA请求

![[Pasted image 20210404174326.png]]

### 单脉冲模式
众多模式中的一个特例
通过一**个激励启动计数器**在一个**程序可控的延时**之后产生一个**脉宽可程序控制的脉冲**
从模式计数器，在**输出比较**模式和**PWM模式**下产生波形，设置TIMx_CR1寄存器中的OPM位将选择单脉冲模式，这样可以让计数器自动地在产生下一个更新事件UEV时停止

仅当**比较值**和**计数器初始值不同**时，才能产生一个脉冲
启动之前(当定时器正在等待触发)必须配置如下：
+ 向上计数模式：计数器CNT\<CCRx\<ARR
+ 向下计数模式：计数器CNT>CCRx

例如需要从TI2输入脚上检测到一个上升沿后开始，延迟tDELAY之后，在OC1上产生一个长度为tPULSE的正脉冲
![[Pasted image 20210404175630.png]]

### 编码器接口模式
#### 编码器
将信号或数据进行**编制**、**转换成**可以**用于通讯、传输和存储的信号**心事的设备
变压器把**角位移**或**直线位移**转换成**电信号**，前者称为**码盘**，后者称为**码尺**

按照**读出方式**，编码器可以分为**接触式**和**非接触式**两种
按照**工作原理**，可以分为**增量式**和**绝对式**两类

增量式编码器将位移转化成周期性的电信号,再把这个点信号编程计数脉冲，用脉冲的个数表示位移大小，绝对式编码器的每一个位置对应一个确定的数字码，因此它的示值只与测量的起始和终止位置有关，与测量的中间过程无关

![[Pasted image 20210404180939.png]]
#### 增量式编码器
通常有三个信号输出，分别为A、B、Z相(有些也标称为C相)输出，A、B相之间相互延迟1/4个周期(90度)的脉冲输出，根据延迟关系可以区分正反转，而且通过取A相、B相的上升和下降边沿，可以进行2或者4倍频；Z相为单圈脉冲，即没圈发出一个脉冲。

增量测量发的光栅由周期性栅条组成。位置信息通过计算自某点开始的增量数(测量步距数)获得。
由于必须用绝对参考点切丁位置值，因此圆光栅码盘还有一个参考点轨
**将位移转换成周期性的电信号，再把这个电信号编程计数脉冲，用脉冲的个数表示位移的大小**
![[Pasted image 20210404184726.png]]

#### 绝对式编码器：
对应一圈，**每个基准的角度发出一个唯一与该角度对应的二进制数值**，通过外部记圈起件进行多个位置的记录和测量
**通过读取边码盘上的二进制的编码信息来表示绝对位置的信息**

编码盘时按照一定的**编码形式**制成的圆盘
途中空白部分时透光的，用0来表示
涂黑的部分是不透光的，用1来表示
将组成编码的圈称为码道，每个码道对应二进制数的一位，最外侧时最低位，嘴里侧时最高位

![[Pasted image 20210404185502.png]]
增量编码器与绝对式编码器区
在**增量编码器**的情况下，位置是从0位标记开始计算的脉冲数量确定的，而**绝对式编码器的位置是由输出代码的度数确定的，在一圈里，每个位置的输出代码的读书是唯一的，因此当电源断开时，绝对式的编码器并不与实际的位置分离**
如果电源再次接通，位置度数仍然是当前的有效的

分辨率：编码器的轴每转一圈所输出的脉冲数
编码器以没转360度提供多少的通或暗刻线称为分辨率，也成为解析分度、或直接称多少线，一般在每转分度5~10000线

最大响应频率：编码器在1S内能响应的最大脉冲数
$$最高响应频率(Hz)=编码器分辨率*轴的转速(R/min)/60$$
最大转速：编码器机械系统能承受的最高转速
绝对编码器信号的传输方式：并行、串行输出或总线型输出
输出电路与增量编码器相似，有集电极开路PNP、NPN型，差分驱动推挽式

#### STM32编码器接口模式
编码器信号接口，由于A、B两相相差90度，可通过比较A相在前还是B相在前，来判别编码器的正传还是反转，通过零位脉冲，可以获得编码器的零位参考位
**四种接线方法**
+ A相连接，用于单方向计数，单方向测速
+ A、B相连接，用于正反向计数，判断正反向和测速
+ A、B、Z三相连接，用于代参考位的位置测量
+ A、A-、B、B-、Z、Z-连接(类似差分信号)，由于带有对称复信号的连接，电流对于电缆的贡献的电磁场为0,衰减小、刚干扰性最佳，可以远距离传输

![[Pasted image 20210404192825.png]]
STM32的编码器接口：**高级控制定时器和通用定时器专用编码器接口**
两个输入**TI1和TI2**被用来作为编码器接口
设置TIMx_SMCR寄存器中的SMS=001,则计数器只在TI2的边沿计数；
设置SMS=010,只在TI1的边沿计数；
设置SMS=011,计数器同时在TI1和TI2边沿计数

通过设置TIMx_CCER寄存器中的CC1P和CC2P位，可以选择TI1和TI2极性；
结合SMS位控制，可以实现1、2、5倍频检测
如果需要还可以输入滤波器编程

编码器接口模式基本上相当于使用了一个**带有方向选择的外部时钟**
计数器只在0到TIMx_ARR寄存器的自动装载之间连续计数(根据方向、或是0到ARR计数，或是ARR到0计数)
开始计数前必须配置TIMx_ARR
捕获器、比较器、预分频器、重复计数器、出发输出特性等扔工作如常

**计数器一招增量编码器的速度和方向被自动修改**，因此计数器的内容始终指示着**编码器的位置**计数方向与相连的传感器旋转的方向对应
![[Pasted image 20210404194956.png]]
![[Pasted image 20210404195716.png]]

### 霍尔传感器接口
多用于电机控制
**定时器输入异或功能：一般用于与霍尔传感器连接**
+ TIMx_CR2寄存器中的TI1S位，允许通道1的输入滤波器连接到一个**异或门的输出端**，异或门的3个输入端为**TIMx_CH1、TIMx_CH2和TIMx_CH3**
+ 异或输出能够被用于所有定时器的输入功能，如触发输入捕获

![[Pasted image 20210404200720.png]]

#### 霍尔传感器
根据霍尔效应制作的一种磁场传感器，可以有效的反应通过**霍尔原件**的**磁密度**
![[Pasted image 20210404201316.png]]
霍尔传感器的BLDC电机与霍尔传感器安装示意图
![[Pasted image 20210404201402.png]]
![[Pasted image 20210404202507.png]]
+ 机械角度试纸点击转子的旋转角度
+ 电角度是指磁场的旋转角度
+ 当转子为一对极时，θm=θe
+ 当转子为n对极时，n*θm=θe

当电机按一定方向转动时，3个霍尔的输出会按照6步的规律变化
![[Pasted image 20210404203129.png]]

每个霍尔信号都对应一个BLDC控制步，使得BLDC旋转一个角度
![[Pasted image 20210404203409.png]]
![[Pasted image 20210404203429.png]]

### STM32霍尔传感器接口
从模式控制器(用于霍尔传感器的定时器)被配置于复位模式，从输入的事TI1F_ED
没当**3个输入之一变化**时计数器重新从0开始计数，这样产生一个由霍尔输入端的**任何变化**而触发的时间基准

**接口定时器**(用于霍尔传感器的定时器)上的捕获/比较通道1配置为捕获模式，捕获信号为TRC。捕获值(TIMx_CC1R)反应了两个驶入变化件的**时间延迟**，由此给出马达速度的信息

接口定时器可以用于**输出模式**产生一个脉冲，这个脉冲可以(通过触发一个COM事件)用于高级定时器各个通道的属性，而高级定时器产生**PWM信号驱动马达**
因此"接口定时器"通道必须编程为在一个**指定的延时**(输出比较或PWM模式)之后产生一个**正脉冲**，这个脉冲通过TRGO输出被送到高级定时器。

![[Pasted image 20210404205152.png]]

#### 霍尔传感器的一般配置
+ 值TIMx_CR2寄存器的TI1S位为'1'，配置三个定时器输入**异或到TI1输入**
+ 时基编程：置TIMx_ARR为其最大值0xffff(计数器必须通过TI1的变化**清零**，从模式控制器的**复位模式**)设置预分频器得到一个最大的计数器周期，他应该长于传感器上的两次变化的**时间间隔**，所以有时候可能会动态的改变预分频的值
+ 设置通道1为捕获模式(选中TRC)：置TIMx_CCMR1寄存器中的CC1S=01,如果需要，可以设置数字滤波器
+ 设置通道2为PWM2模式，并且具有要求的延时：值TIMx_CCMR1寄存器中的OC2M=111(PWM2模式)和CC2S=00(比较输出)
+ 选择OC2REF作为TRGO上的触发输出：置TIMx_CR2寄存器中的MMS=101


使用高级定时器产生6步PWM信号驱动马达(一般是直流无刷BLDC电机或者永磁同步电机PMSM)时，可以用另一个**通用的TIMx**定时器作为"**接口定时器**"来连接霍尔传感器，3个定时器输入脚(CC1,CC2,CC3)通过一个**异或门**连接到TI1输入通道(通过设置TIMx_CR2寄存器中的TI1S位来选择)，**接口定时器**来捕获这个信号

![[Pasted image 20210404211150.png]]


### TIMx定时器和外部出发的同步
STM32的定时器都可以通过外部信号触发(高低电平、边沿出发)而启动，还可以通过**另一个定时器**的**某一个条件**触发而启动
某一个条件可以是定时器到时间、定时超时、比较成功等许多条件
通过一个定时器触发另一个定时器的工作方式称之为**定时器的同步**，**发出出发信号**的定时器工作于**主模式**，接受触发信号而启动的定时器工作于从模式

#### 从模式：
从模式工作模式
+ **复位模式**：再发生一个触发输入事件时，计数器和它的预分频器能够诚信被初始化
+ **门控模式**：按照选中的输入端电瓶使能计数器
+ **触发模式**：输入端上选中的时间使能计数器
+ **外部模式2+触发模式**：ETR信号被用作外部时钟的输入，在复位模式、门控模式或出发模式可以选择另一个输入作为触发输入

![[Pasted image 20210404212256.png]]

##### 复位模式
发生一个触发输入事件时，计数器和它的预分频器能够重新被初始化；同时期如果TIMx_CR1寄存器的URS位变低，还产生一个更新事件UEV；然后所有的预装载寄存器(TIMx_ARR,TIMxCCRx)都被更新了

实例：TI1输入端的上升沿导致向上计数器别被清零
+ 配置通道1以检测TI1的上升沿配置输入滤波器的带宽。触发操作中不使用捕获预分频器，所以不需要配置预分频。CC1S位只选择输入捕获源，即TIMx_CCMR1寄存器中CC1S=01。置TIMx_CCER寄存器中CC1P=0以确定极性
+ 置TIMx_SMCR寄存器中SMS=100,配置定时器为复位模式；置TIMx_SMCR寄存器中TS=101,选择TI1作为输入源
+ 置TIMx_CR1寄存器中CEN=1,启动计数器

![[Pasted image 20210404214238.png]]

##### 门控模式
按照选中的输入端电瓶使能计数器
实例：计数器只在TI1为低电平时向上计数
+ 配置通道1以检测TI1上的低电平。配置输入滤波器带宽(本例不需要滤波)，触发操作中不使用捕获预分频器，所以不需要配置。CC1S位用于选择输入捕获源，置TIMx_CCMR1寄存器中CC1S=01。置TIMx_CCER寄存器中CC1P=1以确定极性(只检测低电平)
+ 置TIMx_SMCR寄存器中SMS=101,配置定时器作为门控模式；置TIMx_SMCR寄存器中TS=101,选择TI1作为输入源

只要TI1为低，计数器开始依据内部时钟计数，一旦TI1变高，则停止计数。当计数器开始或停止时都设置TIMx_SR中的TIF标志

TI1上升沿和计数器实际停止之间的延时取决于TI1输入端的冲同步电路

![[Pasted image 20210404215216.png]]

##### 触发模式
输入端上选中的时间使能计数器
实例：计数器在TI2输入的上升沿开始向上计数
+ 配置通道2检测TI2的上升沿。配置输入滤波器带宽(本例中不需要)出发操作中不使用捕获预分频器，不需要配置。CC2S位位于选择输入捕获源，置TIMx_CCMR1寄存器中CC2S=01.置TIMx_CCER寄存器中的CC2P=1以确定极性(只检测低电平)
+ 置TIMx_SMCR寄存器中SMS=110,配置定时器作为出发模式；置TIMx_SMCR寄存器中TS=110,选择TI2作为输入源。

![[Pasted image 20210404215807.png]]


##### 外部时钟2+触发模式
外部时钟2+触发模式：外部时钟2可以与另一种从模式(外部模式1和编码器模式除外)一起使用，这时，ETR信号被用作外部时钟的输入，在复位模式、门控模式或触发模式可以选择另一个输入作为触发输入

实例：TI1上出现一个上升沿，计数器即在ETR的每一个上升沿向上计数一次：
+ 通过TIMx_SMCR寄存器配置外部触发输入电路
	+ ETF=0000：没有滤波
	+ ETPS=00：不用预分频器
	+ EYP=0：检测ETR的上升沿，置ECE=1使能外部时钟模式2

+ 按配置通道1,检测TI的上升沿
	+ IC1F=0000：没有滤波
	+ 触发操作中不使用捕获预分频器，不需要配置
	+ 置TIMx_CCMR1寄存器中CC1S=01,专责输入捕获源
	+ 置TIMx_CCER寄存器中的CC1P=0以确定极性(只检测上升沿)

+ 置TIMx_SMCR寄存器中SMS=110,配置定时器为触发模式，置TIMx_SMCR寄存器中TS=101,选择TI1作为输入源

当TI1上出现一个上升沿时，TIF标志被设置，计数器开始在ETR的上升沿计数
ETR信号的上升沿和计数器实际复位时间延时，取决于ETRP输入端的重同步电路


### 定时器同步
所有TIMx定时器在**内部相连**，用于定时器同步或者链接
当一个定时器处于主模式时，他可以对另一个处于从模式的定时器的计数器进行复位、启动、停止或者提供时钟等操作
+ 使用一个定时器作为另一个定时器的预分频器
+ 使用一个定时器使能另一个定时器
+ 使用一个定时器启动另一个定时器
+ 使用一个外部出发同步地启动两个定时器

![[Pasted image 20210405185350.png]]

##### 使用一个定时器作为另一个定时器的预分频器
![[Pasted image 20210405185644.png]]
配置定时器1为主模式，可以在骂一个更新事件UEV时输出一个周期性的触发信号。
在TIM1_CR2寄存器的MMS=101时，每当产生一个更新事件时，在TRGO1上输出一个上升沿信号
连接定时器1(主模式)的TRGO1输出至定时器2(从模式),设置TIMx_SMCR寄存器的TS=000,配置定时器2为使用TIR0作为内部触发的从模式
吧从模式控制器(定时器2)置于外部时钟模式1(TIM2_SMCR寄存器的SMS=111)；这样定时器即可以由定时器1周期性的上升沿(即定时器1的计数器溢出)信号驱动
必须设置相应的(TIMx_CR1寄存器)的CEN位分别启动两个定时器

##### 使用一个定时器定时器使能另一个定时器
定时器2的使能由定时器1的输出比较控制
只有当定时器1的OC1REF为高时，定时器2才对分频后的内部时钟计数。
定时器2配置为门控模式，两个定时器的时钟频率都是有预分频器的CK_INT除以3(fCK_CNT=fCK_INT/3)得到的
定时器2的时钟不与定时器1的时钟同步，这个模式只影响定时器2计数器的使能信号
![[Pasted image 20210405190745.png]]
 
##### 使用一个定时器启动另一个定时器
使用定时器1的更新事件使能定时器2
一旦定时器1产生更新事件，定时器2即从它当前的数值(可以是0)按照分频的内部时钟开始计数，在受到出发信号时，定时器2的CEN位被自动置1,同时计数器开始计数直到写0到TIM2_CR1寄存器的CEN位
定时器2配置为触发模式，两个定时器的时钟频率都是由预分频器对CK_INT除以3(fCK_CNT=fCK_INT/3)
![[Pasted image 20210405191351.png]]

##### 使用一个外部出发同步地启动两个定时器
当定时器1的TI1输入上升时使能定时器1，使能定时器1的同时使能定时器2
为保证计数器的对齐，定时器1必须配置为主/从模式(对应TI1为从，对应定时器2为主)
当定时器1的TI1上出现一个上升沿时，两个定时器同步按照内部时钟开始计数，两耳光TIF标志也同时被置1
![[Pasted image 20210405191853.png]]

## 总结——编程手册分析
### 高级定时器
高级定时器由16位自动重装载计数器组成，由一个可编程的预分频器驱动
**高级定时器用途：**
测量输入信号的脉冲宽度、产生输出波形
输出波形包括：输出比较、PWM波、嵌入死区时间的互补PWM等

使用定时器预分频器和RCC时钟控制预分频器，可以实现脉冲宽度和波形周期从几个us到几个ms的调节

高级定时器和通用定时器完全独立，不共享任何资源，可以**同步操作**

### 高级定时器的主要特征
16位向上、向下、中间对齐的自动重装载计数器
16位可编程预分频器
4个独立通道
+ 输入捕获
+ 输出比较
+ PWM生成
+ 单脉冲模式输出

死区时间可编程的互补输出

使用外部信号控制定时器和定时器互联的同步电路

允许在指定数目的计数器周期之后更新定时器的**重复计数器**

刹车输入信号可以将定时器输出信号置于复位状态或者一个已知状态

支持针对定位的增量(正交)编码器和霍尔传感器电路

触发输入作为外部时钟或者按周期的电流管理

### 产生中断/DMA：
+ 更新：计数器发生溢出，计数器初始化(通过软件或者内部/外部触发)
+ 触发事件(计数器启动、停止、初始化或者内部/外部触发计数)
+ 输入捕获
+ 输出比较
+ 刹车信号输入

### 高级定时器功能描述
#### 时基单元
可编程高级定时器主要有一个16位计数器和与之相关的自动重装载寄存器
计数器可以向上向下以及中间对齐计数
计数器的时钟由预分频器分频得到

时基单元包括：
+ 计数器寄存器(TImx_CNT)
+ 预分频器寄存器(TIMx_PSC)
+ 自动重装载寄存器(TIMx_ARR)
+ 重复次数寄存器(TIMx_RCR)

#### 计数器模式
##### 向上计数模式
计数器从0计数到自动加载值(TIMx_ARR计数器的内容),然后重新从0开始计数并且产生一个计数器溢出事件

如果使用了重复计数器功能,在向上计数达到设置的重复计数次数(TIMx_RCR)时,产生更新事件(UEV)
否则每次计数器溢出时才产生更新事件。

##### 向下计数模式

在向下模式中,计数器从自动装入的值(TIMx_ARR计数器的值)开始向下计数到0,然后从自动装入的值重新开始并且产生一个计数器向下溢出事件。

如果使用了重复计数器,当向下计数重复了重复计数寄存器(TIMx_RCR)中设定的次数后,将产生更新事件(UEV)
否则每次计数器下溢时才产生更新事件。

##### 中央对齐模式
在中央对齐模式,计数器从0开始计数到自动加载的值(TIMx_ARR寄存器)−1,产生一个计数器溢出事件,然后向下计数到1并且产生一个计数器下溢事件;然后再从0开始重新计数。

可以在每次计数上溢和每次计数下溢时产生更新事件;也可以通过(软件或者使用从模式控制器)设置TIMx_EGR寄存器中的UG位产生更新事件。然后,计数器重新从0开始计数,预分频器也重新从0开始计数。


#### 重复计数器
时基单元解释了计数器上溢/下溢时更新事件(UEV)是如何产生的,然而事实上它只能在重复计数达到0的时候产生。
**这个特性对PWM信号非常有用**
每N次计数上溢或下溢时,数据从预装载寄存器传输到影子寄存器,N是TIMx_RCR重复计数寄存器中的值
**重复计数器递减条件：**
+ 向上计数模式下每次计数器溢出时
+ 向下计数模式下每次计数器下溢时
+ 中央对齐模式下每次上溢和每次下溢时。

不同模式下更新速率的例子,及TIMx_RCR的寄存器设置
![[Pasted image 20210405204314.png]]

#### 时钟选择
计数器的时钟可有以下时钟源提供
内部时钟：CK_INT
外部时钟模式1：外部输入引脚
外部时钟模式2：外部触发输入ETR
内部触发输入(ITRx)：使用一个定时器作为另一个定时器的预分频器。



#### 捕获/比较通道
每一个捕获/比较通道都是围绕着一个捕获/比较寄存器(包含影子寄存器),包括捕获的输入部分(数字滤波、多路复用和预分频器)，和输出部分(比较器和输出控制)
![[Pasted image 20210405210327.png]]
输入部分对相应的TIx输入信号采样,并产生一个滤波后的信号TIxF。
然后,一个带极性选择的边缘监测器产生一个信号(TIxFPx),它可以作为从模式控制器的输入触发或者作为捕获控制。
该信号通过预分频进入捕获寄存器(ICxPS)。

输出部分产生一个中间波形OCxREF(高有效作为基准)，链的末端决定最终输出信号的极性

捕获/比较通道1的主线路
![[Pasted image 20210405211558.png]]

捕获/比较通道的输出部分

![[Pasted image 20210405211619.png]]

#### 输入捕获模式
在输入捕获模式下,当检测到ICx信号上相应的边沿后,计数器的当前值被锁存到捕获/比较寄存器(TIMx_CCRx)中。
当发生捕获事件时,相应的CCxIF标志(TIMx_SR寄存器)被置1,如果开放了中断或者DMA操作,则将产生中断或者DMA请求。

如果发生捕获事件时CCxIF标志已经为高,那么重复捕获标志CCxOF(TIMx_SR寄存器)被置1

写CCxIF=0可清除CCxIF,或读取存储在TIMx_CCRx寄存器中的捕获数据也可清除CCxIF
写CCxOF=0可清除CCxOF

下面例子说明如何在TI1输入上升沿时**捕获计数器的值**到TIMx_CCR1寄存器中
+ 选择有效输入端:TIMx_CCR1必须连接到TI1输入,所以写入TIMx_CCR1寄存器中的CC1S=01,只要CC1S不为’00’,通道被配置为输入,并且TIMx_CCR1寄存器变为读。
+ 根据输入信号的特点,配置输入滤波器为所需的带宽(即输入为TIx时,输入滤波器控制位是TIMx_CCMRx寄存器中的ICxF位)。假设输入信号在最多5个内部时钟周期的时间内抖动,我们须配置滤波器的带宽长于5个时钟周期;因此我们可以(以f DTS 频率)连续采样8次,以确认在TI1上一次真实的边沿变换,即在TIMx_CCMR1寄存器中写入IC1F=0011
+ 选择TI1通道的有效转换边沿,在TIMx_CCER寄存器中写入CC1P=0(上升沿)。
+ 配置输入预分频器。在本例中,我们希望捕获发生在每一个有效的电平转换时刻,因此预分频器被禁止(写TIMx_CCMR1寄存器的IC1PS=00)
+ 设置TIMx_CCER寄存器的CC1E=1,允许捕获计数器的值到捕获寄存器中
+ 如果需要,通过设置TIMx_DIER寄存器中的CC1IE位允许相关中断请求,通过设置TIMx_DIER寄存器中的CC1DE位允许DMA请求

当发生一次输入捕获时：
+ 产生有效的电平转换时,计数器的值被传送到TIMx_CCR1寄存器。
+ CC1IF标志被设置(中断标志)。当发生至少2个连续的捕获时,而CC1IF未曾被清除,CC1OF也被置1
+ 如设置了CC1IE位,则会产生一个中断
+ 如设置了CC1DE位,则还会产生一个DMA请求

##### PWM输入模式
PWM是输入捕获模式的一个特例
除下列区别外,操作与输入捕获模式相同:
+ 两个ICx信号被映射至同一个TIx输入
+ 这2个ICx信号为边沿有效,但是极性相反。
+ 其中一个TIxFP信号被作为触发输入信号,而从模式控制器被配置成复位模式。
+ 选择TIMx_CCR1的有效输入:置TIMx_CCMR1寄存器的CC1S=01(选中TI1)。
+ 选择TI1FP1的有效极性(用来捕获数据到TIMx_CCR1中和清除计数器):置CC1P=0(上升沿有效)
+ 选择TIMx_CCR2的有效输入:置TIMx_CCMR1寄存器的CC2S=10(选中TI1)。
+ 选择TI1FP2的有效极性(捕获数据到TIMx_CCR2):置CC2P=1(下降沿有效)。
+ 选择有效的触发输入信号:置TIMx_SMCR寄存器中的TS=101(选择TI1FP1)。
+ 配置从模式控制器为复位模式:置TIMx_SMCR中的SMS=100。
+ 使能捕获:置TIMx_CCER寄存器中CC1E=1且CC2E=1。

PWM输入模式时序图
![[Pasted image 20210405212758.png]]
只有TI1FP1和TI2FP2连到了从模式控制器，所以PWM输入模式只能使用TIMx_CH1/TIMx_CH2信号

#### 强置输出模式
在输出模式(TIMx_CCMRx寄存器中CCxS=00)下,输出比较信号(OCxREF和相应的OCx/OCxN)能够直接由软件强置为有效或无效状态，而不依赖于输出比较寄存器和计数器间的比较结果。

置TIMx_CCMRx寄存器中相应的OCxM=101,即可强置输出比较信号(OCxREF/OCx)为有效状态。这样OCxREF被强置为高电平(OCxREF始终为高电平有效),同时OCx得到CCxP极性相反的信号。

#### 输出比较模式
控制输出波形，或者指示一段给定的时间已经到时
当计数器与捕获/比较寄存器的内容相同时,输出比较功能做如下操作：
+ 将输出比较模式(TIMx_CCMRx寄存器中的OCxM位)和输出极性(TIMx_CCER寄存器中的CCxP位)定义的值输出到对应的引脚上。
	`在比较匹配时,输出引脚可以保持它的电平(OCxM=000)、被设置成有效电平(OCxM=001)、被设置成无效电平(OCxM=010)或进行翻转(OCxM=011)`
	
+ 设置中断状态寄存器中的标志位(TIMx_SR寄存器中的CCxIF位)。
+ 若设置了相应的中断屏蔽(TIMx_DIER寄存器中的CCxIE位),则产生一个中断。
+ 若设置了相应的使能位(TIMx_DIER寄存器中的CCxDE位,TIMx_CR2寄存器中的CCDS位选择DMA请求功能),则产生一个DMA请求















