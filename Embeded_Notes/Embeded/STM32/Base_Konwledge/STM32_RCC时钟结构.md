## 1. 时钟框图

> 有三种不同的时钟来源可以驱动系统时钟
>
> + HSI 内部高速时钟
> + HSE 外部高速时钟
> + 主PLL(锁相环时钟)时钟

![[Pasted image 20210308143724.png]]

### 1.1 HSE 时钟 (高精度)

> 外部高速时钟 

来源：无源晶振 或者 外部用户时钟

![[Pasted image 20210308143755.png]]

**外部时钟源需将RCC->CR的HSEBYP和HSEON 选1使能**

_必须使用占空比约为 50% 的外部时钟信号(方波、正弦波或三角波)来驱动 OSC_IN 引脚,同时 OSC_OUT 引脚应保持为高阻态，谐振器和负载电容必须尽可能地靠近振荡器的引脚,以尽量减小输出失真和起振稳定时间。**负载电容值必须根据所选振荡器的不同做适当调整**_

### 1.2 HSI 时钟 (低成本)

> 内部高速时钟
>
> 无需使用外部晶振，低成本，但是受环境影响较大

来源：内部16MHz RC振荡器

RCC->RC的 HSION 来开启或者关闭，由RCC->RC的 HSIRDY确定是否稳定(硬件自动置1)

### 1.3 PLL时钟 

> 锁相环时钟
>
> F4xx器件有两个PLL

1. **主PLL**

   来源：HSE或者HSI

   具有两个不同的输出时钟：

   + 输出生成高速时钟(最高可达168MHZ)
   + 输出用于生成USB OTG FS 的时钟(48MHZ)、随机数发生器的时钟(<=48MHz)和SDIO的时钟(<=48MHz)

   _在PLL使能后配置参数不可更改，因此应先配置使能HSI或者HSE作为PLL时钟源，并且进行初始化_

2. **PPLI2S使用与PLL相同的输入时钟**
   _PLLI2S是具有咱们的使能/禁止和分频系数配置位PLL2使能后，配置参数也不能更改_
   当进入停机和待机模式后,两个 PLL 将由硬件禁止;如将 HSE 或 PLL(由 HSE 提供时钟信号)用作系统时钟,则在 HSE 发生故障时,两个 PLL 也将由硬件禁止。

### 1.4 LSE时钟

> 低速外部时钟
>
> 外部源LSE旁路：必须提供外部时钟源，不超过1MHz，通过LSEBYP和LSEON置1选择

LSE 晶振是 32.768 kHz 低速外部 (LSE) 晶振或陶瓷谐振器,可作为实时时钟外设 (RTC) 的
时钟源来提供时钟 /日历或其它定时功能,具有功耗低且精度高的优点。

_通过RCC->BDCR中的 LSEON开启和关闭，并通过LSERDY来判断是否使能成功_

### 1.5 LSI时钟

> 低速内部时钟

**LSI RC 可作为低功耗时钟源在停机和待机模式下保持运行，供独立看门狗和自动唤醒单元(AWU)使用，频率在32KHz左右，通过RCC->CSR的LSION来打开或者关闭，并根据LSIRDY判断是否使能成功**

如果在RCC_CIR中使能中断，则可以产生中断

### 1.6 SysCLK时钟

> 系统时钟
>
> 系统复位后，默认使用HSI
> **在直接使用 HSI 或者通过 PLL 使用时钟源来作为系统时钟时,该时钟源无法停止**

### 1.7 时钟安全系统 

> 时钟安全系统可以通过软件激活

时钟监测器将在 HSE 振荡器启动延迟后使能,并在此振荡器停止时被关闭

如果 HSE 时钟发生故障,此振荡器将自动禁止,**一个时钟故障事件将发送到高级控制定时器 TIM1 和 TIM8 的断路输入**,并且同时还将生成一个中断来向软件通知此故障(时钟安全系统中断,CSSI),以使 MCU 能够执行救援操作。

*当 CSS 使能后,如果 HSE 时钟偶发故障,则 CSS 将生成一个中断,进而促使 NMI 自动生成。 NMI 将无限期执行,除非将 CSS 中断挂起位清零。因此,应用程序必须在 NMI ISR 中将 CSS 中断清零,具体方式为在时钟中断寄存器 (RCC_CIR) 中将 CSSC 位置 1*

**如果直接或间接使用 HSE 振荡器作为系统时钟(间接是指该振荡器直接用作 PLL 的输入时钟,并且该 PLL 时钟为系统时钟)并且检出故障,则系统时钟将切换到 HSI 振荡器并且HSE 振荡器将被禁止。**

*如果 HSE 振荡器时钟是充当系统时钟的 PPL 的时钟源,则在发生故障时,PLL 也会被禁止。在此情况下,如果 PLLI2S 已使能,则在 HSE 发生故障时也会将其禁止。*

### 1.8 RTC/AUW时钟

> 实时时钟
>
> RTCCLK 时钟源可以是 HSE 1 MHz(HSE 由一个可编程的预分频器分频)、LSE 或者 LSI时钟
>选择方式是编程 RCC 备份域控制寄存器 (RCC_BDCR) 中的 RTCSEL[1:0] 位和 RCC时钟配置寄存器 (RCC_CFGR) 中的 RTCPRE[4:0] 位。所做的选择只能通过复位备份域的方式修改。

如果选择 LSE 作为 RTC 时钟,则系统电源丢失时 RTC 仍将正常工作。
如果选择 LSI 作为AWU 时钟,则在系统电源丢失时将无法保证 AWU 的状态。
如果 HSE 振荡器通过一介于2 和 31 之间的值进行分频,则在备用或系统电源丢失时将无法保证 RTC 的状态。

_**LSE时钟位于备选域中，而HSE和LSI则不是**_

因此

+ 如果选择LSE作为RTC时钟,只要 VBAT 电源保持工作,即使VDD电源关闭,RTC仍可继续工作
+ 如果选择LSI作为自动唤醒单元(AWU) 时钟,在VDD电源掉电时,AWU 的状态将不能保证
+ 如果使用HSE时钟作为RTC时钟，如果 V DD 电源掉电或者内部调压器关闭(切断 1.2 V 域的供电),则RTC 的状态将不能保证

*要在 APB1 时钟频率低于 RTC 时钟频率的七倍时 (f APB1 < 7xf RTCLCK ) 读取 RTC 日历寄存器,软件必须两次读取日历时间寄存器和日期寄存器。如果对 RTC_TR 的第二次读取访问得到的结果与第一次相同,则表明数据正确无误。否则必须执行第三次读取访问。*

### 1.9 看门狗时钟

如果独立看门狗 (IWDG) 已通过硬件选项字节或软件设置的方式启动,则 LSI 振荡器将强制
打开且不可禁止。在 LSI 振荡器稳定后,时钟将提供给 IWDG

### 1.10 时钟输出功能

共有两个微控制器时钟输出(MCO)引脚
所需的时钟源通过 RCC 时钟配置寄存器 (RCC_CFGR) 中的 MCO2PRE[2:0] 和 MCO2位选择。

+ MCO1：

  用户可通过可配置的预分配器(从 1 到 5)向 MCO1 引脚 (PA8) 输出四个不同的时钟源

  + HSI 时钟
  + LSE 时钟
  + HSE 时钟
  + PLL 时钟

+ MCO2：

  用户可通过可配置的预分配器(从 1 到 5)向 MCO2 引脚 (PC9) 输出四个不同的时钟源

  + HSE 时钟
  + PLL 时钟
  + 系统时钟
  + PLLI2S时钟

对于不同的 MCO 引脚,必须将相应的 GPIO 端口在复用功能模式下进行设置。MCO 输出时钟不得超过 100 MHz(最大 I/O 速度)。

### 1.11 基于TIM5/TIM11的内部/外部时钟测量

>所有时钟源的频率都可通过对 TIM5 channel4 和 TIM11 channel1 的输入捕获进行间接测量

#### 1.11.1 基于 TIM5 channel4 的内部 /外部时钟测量

TIM5 具有一个输入复用器,可选择输入捕获是由 I/O触发还是由内部时钟触发。此选择通过TIM5_OR 寄存器的 TI4_RMP [1:0] 位执行。

![[Pasted image 20210308143841.png]]

#### 1.11.2 基于 TIM11 channel1 的内部/ 外部时钟测量

TIM11 具有一个输入复用器,可选择输入捕获是由 I/O 触发还是由内部时钟触发。此选择通
过 TIM11_OR 寄存器的 TI1_RMP [1:0] 位执行。

#### 1.11.2 基于 TIM11 channel1 的内部/ 外部时钟测量

TIM11 具有一个输入复用器,可选择输入捕获是由 I/O 触发还是由内部时钟触发。此选择通
过 TIM11_OR 寄存器的 TI1_RMP [1:0] 位执行。

![[Pasted image 20210308143952.png]]

RCC配置编程[[STM32_RCC编程]]