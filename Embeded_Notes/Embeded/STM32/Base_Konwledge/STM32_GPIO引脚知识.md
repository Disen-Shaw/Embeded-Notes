# STM32GPIO知识

## 1. GPIO简介

> GPIO——general purpose input output


通用输入输出端口，软件可控制的引脚，STM32芯片的GPIO引脚与外部设备连接起来，从而实现与外部通讯、控制以及数据采集
> 功能框图

![[Pasted image 20210308004923.png]]
### 1.1 框图说明

> 虚线框右边为保护芯片电路，IO口不能直接接负载电路，需要先经过驱动电路

+ 保护二极管

  IO引脚上下两边两个二极管用于防止引脚外部过高、过低的电压输入，当引脚电压高于VDD时，上方的二极管导通，当引脚电压低于VSS时，下方的二极管导通，防止不正常电压引入芯片导致芯片烧毁，但是过大的电压一样会损毁芯片

+ 上拉、下拉电阻

  控制引脚默认状态的电压
  开启上拉的时候引脚默认电压为高电平，开启下拉的时候引脚默认电压为低电平

+ TTL施密特触发器

  基本原理是当输入电压高于正向阈值电压，输出为高；
  当输入电压低于负向阈值电压，输出为低。
  IO口信号经过触发器后，模拟信号转化为0和1的数字信号也就是高低电平，并且是TTL电平协议
  这也是为什么STM32是TTL电平协议的原因

+ P-MOS管和N-MOS管

  P-MOS管高电平导通，低电平关闭
  下方的N-MOS低电平导通，高电平关闭
  VDD_FT  代表IO口，兼容3.3V和5V，如果没有标注“FT”，就代表着不兼容5V

## 2. 模式控制

### 2.1 GPIO工作模式

> 四种输入模式

+ 浮空输入模式 GPIO_Mode_IN_FLOATING
+ 上拉输入模式 GPIO_Mode_IPU
+ 下拉输入模式 GPIO_Mode_IPD
+ 模拟输入模式 GPIO_Mode_AIN

> 四种输出模式

+ 开漏输出模式 GPIO_Mode_Out_OD
+ 复用开漏输出 GPIO_Mode_AF_OD
+ 推挽输出模式 GPIO_Mode_Out_PP
+ 复用推挽输出 GPIO_Mode_AF_PP

> 四种最大输出速度

+ 低速 2MHZ
+ 中速 25MHZ
+ 快速 50MHZ
+ 高速 100MHZ

## 3. GPIO八种工作模式

### 3.1 浮空输入模式

![[Pasted image 20210308005107.png]]
浮空输入模式下，I/O端口的电平信号直接进入输入数据寄存器。MCU直接读取I/O口电平，I/O的电平状态是**不确定**的，完全由外部输入决定；如果在该引脚悬空（在无信号输入）的情况下，**读取该端口的电平是不确定**的，**基本用来做Key按键的识别**。

### 3.2 上拉输入模式

![[Pasted image 20210308005205.png]]
IO内部接上拉电阻，此时如果IO口外部没有信号输入或者引脚悬空，**IO口默认为高电平** 如果I/O口输入低电平，那么引脚就为低电平，MCU读取到的就是低电平 STM32的内部上拉是"弱上拉"，即通过此上拉输出的电流是很弱的，如要求大电流还是需要外部上拉

### 3.3 下拉输入模式

![[Pasted image 20210308005353.png]]
IO内部接下拉电阻，此时如果IO口外部没有信号输入或者引脚悬空，IO口默认为低电平 如果I/O口输入高电平，那么引脚就为高电平，MCU读取到的就是高电平

### 3.4 模拟输入模式

![[Pasted image 20210308005433.png]]
 当GPIO引脚用于ADC采集电压的输入通道时，用作"模拟输入"功能
此时信号不经过施密特触发器，直接直接进入ADC模块，并且输入数据寄存器(IDR)为空
CPU不能在输入数据寄存器上读到引脚状态
**当GPIO用于模拟功能时，引脚的上、下拉电阻是不起作用的**
**这个时候即使配置了上拉或下拉模式，也不会影响到模拟信号的输入输出**

**除了 ADC 和 DAC 要将 IO 配置为模拟通道之外其他外设功能一律要配置为复用功能模式**

### 3.5 开漏输出(带上拉或者下拉)
![[Pasted image 20210308005516.png]]

在推挽输出模式时，N-MOS管和P-MOS管都工作
如果我们控制输出为0，低电平，则P-MOS管关闭，N-MOS管导通，使输出低电平，I/O端口的电平就是低电平
若控制输出为1 高电平，则P-MOS管导通N-MOS管关闭，使输出高电平，I/O端口的电平就是高电平，  外部**上拉和下拉的作用是控制在没有输出时IO口电平**
此时施密特触发器是打开的，即**输入可用**，通过输入数据寄存器GPIOx_IDR可读取I/O的实际状态。
I/O口的电平一定是输出的电平 

### 3.6 开漏输出(带上拉或者下拉)

![[Pasted image 20210308005713.png]]
在开漏输出模式时，只有N-MOS管工作
如果我们控制输出为0，低电平，则P-MOS管关闭，N-MOS管导通，使输出低电平，I/O端口的电平就是低电平
若控制输出为1时，高电平，则P-MOS管和N-MOS管都关闭，输出指令就不会起到作用，此时I/O端口的电平就不会由输出的高电平决定，而是**由I/O端口外部的上拉或者下拉决定**
**如果没有上拉或者下拉 IO口就处于悬空状态**
此时施密特触发器是打开的，即输入可用，通过输入数据寄存器GPIOx_IDR可读取I/O的实际状态I/O口的电平不一定是输出的电平 

### 3.7 复用推挽输出(带上拉或者下拉)

![[Pasted image 20210308005811.png]]
GPIO复用为其他外设(如 I2C)，**输出数据寄存器GPIOx_ODR无效**； 
输出的高低电平的来源于其它外设，施密特触发器打开，**输入可用**，通过输入数据寄存器可获取I/O实际状态，除了输出信号的来源改变 其他与开漏输出功能相同

### 3.8 复用开漏输出(带上拉或者下拉)

![[Pasted image 20210308005850.png]]
GPIO复用为其他外设，输出数据寄存器GPIOx_ODR无效
输出的高低电平的来源于其它外设，施密特触发器打开，**输入可用**，通过输入数据寄存器可获取I/O实际状态  除了输出信号的来源改变 其他与开漏输出功能相同

### 3.9 解析

#### 3.9.1 开漏输出和推挽输出区别

+ 推挽输出

  **可以输出强高低电平，连接数字器件**
  **推挽结构一般是指两个三极管分别受两互补信号的控制,总是在一个三极管导通的时候另一个截止**

+ 开漏输出

  **可以输出强低电平，高电平得靠外部电阻拉高。**
  在任何一种开漏模式时，都要接上拉电阻，否则只能输出低电平

#### 3.9.2 在STM32中选用IO模式

+ 上拉、下拉输入可以检测外部信号，如按键等
+ 模拟输入 ——应用ADC模拟输入，**或者低功耗下省电**
+ 开漏输出一般应用在I2C、SMBUS通讯等需要"线与"功能的总线电路中
+ 推挽输出模式一般应用在**输出电平为0和3.3伏**而且需要高速切换开关状态的场合
  在STM32的应用中，除了必须用开漏模式的场合，都习惯使用推挽输出模式
+ 复用功能的推挽输出_AF_PP ——片内外设功能（I2C的SCL,SDA）
+ 复用功能的开漏输出_AF_OD——片内外设功能（TX1,MOSI,MISO.SCK.SS）

#### 3.9.3 F4系列与F1系列区别

本质上的区别是F4系列采用了**Cortex-M4内核 而**F1系列采用**Cortex-M3内核**

![[Pasted image 20210308005952.png]]
F4系列设计的更加高级与人性化，他将**外部上下拉电阻转移到了输出/输入驱动器外部**，使得输出模式下也可以实现内部上拉与下拉，方便了用户的使用，增加了灵活性

##### F4系列GPIO引脚的初始化(固件库)

1. 定义一个 GPIO_InitTypeDef 类型的结构体
2. 开启 LED 相关的 GPIO 外设时钟 (AHB1)
3. 选择要控制的 GPIO 引脚
4. 设置所选引脚的模式
5. 设定所选引脚的输出类型
   输出模式下配置，输入模式不需要配置
6. 设定所选管脚的速度
7. 设定所选管脚的上拉与下拉
8. 初始化GPIO

## 编程知识
1. [[GPIO_固件库编程]]