# STM32_I2C外设
## STM32 I2C工作模式

### STM32_I2C架构
![[Pasted image 20210309191905.png]]

1. 主机写数据到从机

![[Pasted image 20210309171003.png]]

2. 主机从从机中读取数据

![[Pasted image 20210309171053.png]]

3. I2C复合通讯

![[Pasted image 20210309171116.png]]

### 写数据
若配置的方向传输位为“写数据”方向
广播完地址,接收到应答信号后,主机开始正式向从机传输数据(DATA),数据包的大小为8位
主机每发送完一个字节数据,都要等待从机的应答信号(ACK),
重复这个过程,可以向从机传输 N 个数据,这个 N 没有大小限制。
当数据传输结束时,主机向从机发送一个停止传输信号(P),表示不再传输数据。

### 读数据
若配置的方向传输位为“读数据”方向
广播完地址,接收到应答信号后,从机开始向主机返回数据(DATA),数据包大小也为 8 位
从机每发送完一个数据,都会等待主机的应答信号(ACK),重复这个过程
可以返回 N 个数据,这个 N 也没有大小限制。
主机希望停止接收数据时,就向从机返回个非应答信号(NACK),从机自动停止数据传输。

### 读写数据
除了基本的读写,I2C 通讯更常用的是复合格式
该传输过程有两次起始信号(S)
一般在第一次传输中,主机通过 SLAVE_ADDRESS 寻找到从设备后,发送一段“数据”
这段数据通常用于表示从设备内部的寄存器或存储器地址
在第二次的传输中,对该地址的内容进行读或写
也就是说,第一次通讯是告诉从机读写地址,第二次则是读写的实际内容。

### 通信的起始和结束信号
![[Pasted image 20210309191719.png]]



### 地址以及数据方向
I2C 总线上的每个设备都有自己的独立地址
主机发起通讯时,通过 SDA 信号线发送设备地址(SLAVE_ADDRESS)来查找从机
I2C 协议规定设备地址可以是 7 位或 10 位,实际中 7 位的地址应用比较广泛
紧跟设备地址的数据位用来表示数据传输方向,它是数据方向位(R/W)第 8 位或第11 位
数据方向位为“1”时表示主机由从机读数据,该位为“0”时表示主机向从机写数据

![[Pasted image 20210309191547.png]]

### 响应
I2C 的数据和地址传输都带响应。响应包括“应答(ACK)”和“非应答(NACK)”两种信号
作为数据接收端时,当设备(无论主从机)接收到 I2C 传输的一个字节数据或地址后
若希望对方继续发送数据,则需要向对方发送“应答(ACK)”信号
发送方会继续发送下一个数据;
若接收端希望结束数据传输,则向对方发送“非应答(NACK)”信号,
发送方接收到该信号后会产生一个停止信号,结束信号传输。


### 通讯过程
#### 主发射器
![[Pasted image 20210309192022.png]]
+ 控制产生其实信号S，当发生起始信号，产生事件 EV5 ，会对SR1寄存器的 SB 位置1,表示其实信号已经发送
+ 发送设备地址并等待应答信号，若有从机应答，则产生事件 EV6 以及 EV8 ，这时SR1寄存器的 ADDR 位以及 TXE 位被置1,ADDR置1表示地址已经发送，TXE置1表示发送数据寄存器为空
+ 对ADDR清0后，往I2C的"数据寄存器 DR"写入要发送的数据，这是TXE位会被重置0,表示数据寄存器非空，I2C外设通过重复这个过程，就可以发送多个字节数据
+ 发送数据完成后，控制I2C设备产生一个停止信号，产生EV8_2事件，SR1的TXE位以及BTF位都被置1,表示通讯结束

**如果使能了I2C中断，会产生I2C中断信号，进入中断服务函数**

#### 主接收器
![[Pasted image 20210309192715.png]]

+ 控制产生其实信号S，当发生起始信号，产生事件 EV5 ，会对SR1寄存器的 SB 位置1,表示其实信号已经发送
+ **发送地址信号**之后发送设备等待应答信号，若有从机应答，则产生事件EV6，这时SR1寄存器的ADDR位置置1,表示地址已经发送
+ 从机段接受到地址后，开始想主机端发送数据，当从机接受到数据后，会产生EV7事件，SR1寄存器的RXNE被置1,便是接受数据寄存器非空，读取寄存器后，对数据寄存器清空，接受下一次数据，重复上步接受数据，若非应答，泽停止传输
+ 发送方非应答信号后，产生停止信号，结束传输

在发送和接收过程中,有的事件不只是标志了我们上面提到的状态位,还可能同时标志主机状态之 类的状态 位,而且读了之后还 需要清除标志位,比较复杂 
[[STM32_I2C外设编程]]